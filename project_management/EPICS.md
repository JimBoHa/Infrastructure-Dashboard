# Infrastructure Dashboard Epics

This document provides a detailed description of the high-level epics for the Infrastructure Dashboard project.

> **Workflow:** Use `project_management/TASKS.md` for active tickets (work items); completed tickets live in `project_management/TASKS_DONE_2026.md`; indefinitely deferred/deprecated items live in `project_management/TASKS_DEFERRED_INDEFINITE.md`. This file defines epic scope/goals; epic **Status** should match `project_management/BOARD.md`. Hardware validation is tracked as separate **Validate … on hardware** tickets (`Blocked: hardware validation (...)`). Production validation uses two tiers: Tier A (“validated on installed controller; no DB/settings reset”) and Tier B (“validated on clean host via E2E”), with Tier‑B tracked via cluster validation tickets. Tier‑A evidence must include at least one captured **and viewed** screenshot stored under `manual_screenshots_web/` and referenced from a run log under `project_management/runs/`.

## 1. Core Infrastructure

**Status:** Blocked: clean-host E2E validation (DT-59)

**Description:** This epic covers the setup and configuration of the core infrastructure for the project, including the database, message broker, and other services.

**Goals:**
- Provide a stable and reliable infrastructure for the platform.
- Automate the setup and management of the infrastructure.
- Ship offline provisioning tooling (e.g., first-boot config generator) to support bulk imaging and break-glass setup.
- Ship a local "Sim Lab" that emulates nodes/sensors/outputs so the full stack can run without physical hardware.
- Provide a Sim Lab control plane (separate `tools/sim_lab` service) for scenario/fault orchestration and time/seed controls.
- Ensure Sim Lab deterministically simulates mesh radio diagnostics, BLE provisioning availability, and utility/forecast feeds.
- Run lightweight CI smoke checks against Sim Lab endpoints for adoption/dashboard flows.
- Keep demo-live workflows rerunnable with idempotent migrations and non-conflicting default ports.
- Keep automated test output clean by avoiding extra guardrail reminder logs.
- Codify uptime-first Tier‑A upgrade/rollback discipline on the installed controller (avoid upgrading to known-broken builds; rollback immediately on failure).
- Optimize CI by gating jobs on path changes and providing a doc-only fast path.
- Add smoke vs full test tiers for PRs vs scheduled/label-triggered runs.
- Improve CI caching and concurrency to reduce wasted work.
- Provide a shared pre-commit hook with doc/log/image extension skip to avoid unnecessary local CI runs.
- Standardize structured JSON logging and OpenTelemetry tracing with a local collector + Tempo dashboards.
- Define alpha/beta/stable release channels with semver validation and changelog tooling enforced in CI.
- Adopt a contract-first OpenAPI spec with generated SDKs and CI drift checks across active `main` surfaces (web/node; iOS/watch deferred on `main`).

**Recent Progress:** DT-38/DT-42 are now validated by the installer-path E2E harness (`make e2e-installer-stack-smoke`) and no longer depend on container stacks. DT-39 refactored the `farmctl` entrypoint out of a monolith into focused modules while keeping the installer gate green. DT-44 added a macOS-first Pi 5 network install/HTTP boot prototype runbook and a minimal controller-side helper (`farmctl netboot`) to host netboot artifacts; however, production Pi deployment is now deploy-over-SSH only, so netboot is treated as R&D/deprecated to avoid field confusion (2026-01-18). DT-43 is complete: the repo now emits a versioned Pi 5 “preconfigured media” kit (`tools/build_image.py`) plus a no-CLI operator runbook; however, production Pi deployment is now deploy-over-SSH only, so “preconfigured media” is treated as deprecated for production (2026-01-18). DT-52/DT-51/DT-45 are complete: the controller bundle manifest is now v2 with no dashboard-web entrypoint stub and Sim Lab fixture tooling is consolidated under `tools/sim_lab/`. The WAN portal scaffold was later removed as part of ARCH-6 pruning (non-shipping surface). DT-53 fixes `farmctl native-deps` output path handling for relative destinations so native dependency builds don’t accidentally install into temp workspaces. DT-57 is newly tracked to close the “zero-touch netboot” spec gap (ticket: `project_management/tickets/TICKET-0018-pi5-network-boot-zero-touch-provisioning.md`). 2026-01-14: Completed DT-60 to stabilize the ADS1263 execution plan (`ADC_ADS1263_EXECUTION_PLAN.md`) by splitting the diff into PH commits, canonicalizing ADC docs, and enforcing a clean-git-tree gate for Tier‑A rebuild/refresh workflows. 2026-01-14: Completed DT-61 (“no simulation in production”) by baking build flavor into node-agent artifacts, hard-failing simulator paths in `BUILD_FLAVOR=\"prod\"`, and enforcing fail-closed analog publish (Tier A: installed controller refreshed to `0.1.9.120`; run: `project_management/runs/RUN-20260114-tier-a-dt61-no-sim-prod-0.1.9.120.md`). 2026-01-14: Completed DT-62 to remove “ADS1115” as a user/config concept (API rejects `driver_type=ads1115`, UI has no ADS1115 references; Tier A: installed controller refreshed to `0.1.9.121`; run: `project_management/runs/RUN-20260114-tier-a-dt62-remove-ads1115-0.1.9.121.md`). 2026-01-14: Completed DT-63 to ship a Pi5 ADS1263 hardware backend + deterministic health surface (gpiozero + spidev; `analog_health.last_error` in heartbeat), validated on Node1 and refreshed on the installed controller to `0.1.9.122` (run: `project_management/runs/RUN-20260114-tier-a-dt63-ads1263-backend-health-0.1.9.122.md`). 2026-01-14: Completed DT-64 to validate the end-to-end dashboard “Add hardware sensor” flow for Pi nodes (UI apply → node-agent config → ingest) with no file copying; refreshed installed controller to `0.1.9.123` (run: `project_management/runs/RUN-20260114-tier-a-dt64-add-hardware-sensor-0.1.9.123.md`). 2026-01-14: Completed DT-65 to finalize Reservoir Depth current-loop conversion (163Ω shunt; AIN0 vs AINCOM) with explicit bounds/fault handling; validated on Node1 and refreshed the installed controller to `0.1.9.124` (run: `project_management/runs/RUN-20260114-tier-a-dt65-reservoir-depth-0.1.9.124.md`). 2026-01-23: Completed DT-66 to capture the fastest dashboard-web validation loop (commands + runtime), including the “don’t trust ‘Compiled successfully’” Next build pitfall and requiring exit-code-based reporting. 2026-01-23: Completed DT-67 to codify the loop as `make ci-web-smoke-build` and run it automatically for staged dashboard-web changes via the pre-commit test selector. 2026-01-24: Completed DT-69 to document the full suite + TSSE validation command matrix and reports artifact guidance. 2026-02-06: Completed DT-73 to move iOS/watch off `main` (preserved on `freeze/ios-watch-2026q1`), remove mobile source/CI/hook surfaces, and validate with `make ci-core-smoke`, `make ci-farmctl-smoke`, `make ci-web-smoke-build`, `make e2e-installed-health-smoke`, and `python3 tools/api-sdk/generate.py` (with Java 17 in PATH); run log: `project_management/runs/RUN-20260206-installed-controller-smoke-main-integrity-cleanup.md`. 2026-02-11: Completed DT-74 by adding a Tier‑A screenshot review hard gate (`tools/tier_a_screenshot_gate.py` + `make tier-a-screenshot-gate`) and requiring the run-log hard-gate block in Tier‑A runbook/template docs before validation can be marked complete.

---

## 2. Core Server

**Status:** In Progress (WS-2902 by-node endpoints; Pi 5 SPI bootstrap; battery SOC estimator + power runway projection; DHCP churn validation CS-105)

**Description:** This epic covers the development of the core backend server for the platform. The core server is responsible for handling business logic, data storage, and communication with other components.

**Goals:**
- Provide a robust and scalable backend for the platform.
- Implement all the necessary APIs for the web and mobile clients.
- Ensure the security and reliability of the backend.
- Integrate commercial device protocols (Modbus TCP, SNMP, BACnet/IP, HTTP APIs) with catalog-driven point mapping.
- Ensure all non-health API endpoints that expose sensitive data are authenticated and capability-gated (no unauthenticated read endpoints for metrics/backups/nodes/outputs/schedules/alarms/analytics; no secret leaks via setup credential inventory or the dashboard snapshot).
- Ensure fresh-install bootstrap cannot be hijacked by unauthenticated “first user wins” user creation.
- Ensure predictive control-plane endpoints are real or explicitly disabled (no stubbed “success” endpoints in production).
- Ensure backups/restore are real, observable workflows (no “ok/queued” stub endpoints that perform no work).
- Ensure schedule evaluation is correct across DST transitions (no silently skipped schedule blocks due to local time gaps/ambiguity).
- Keep demo mode test-friendly so automated suites remain deterministic.
- Keep automated tests deprecation-free (UTC timestamps, token handling).
- Centralize forecast and utility rate providers with registry-based file/HTTP integrations and explicit data freshness reporting.
- Host offline map assets (tiles/glyphs/terrain) on the controller so the Map tab has no internet dependency after setup.

**Recent Progress:** 2026-02-17: Completed CS-106 to make related-sensors semantics aware for circular + cumulative-reset sensors (wind direction + daily rain). Tier A validated installed controller `0.1.9.272-cs106-related-sensors` (run: `project_management/runs/RUN-20260217-tier-a-cs106-wind-rain-related-sensors-0.1.9.272-cs106-related-sensors.md`). 2026-02-08: Implemented DHCP-safe node-agent addressing so node DHCP changes do not break config/sensor pushes (CS-104). Core-server now resolves node-agent endpoints via mDNS hostname (`<agent_node_id>.local`) and refreshes `nodes.ip_last` via MAC-matched MQTT heartbeats; Tier‑A validation is tracked as CS-105. 2026-01-18: Implemented CS-88 to centralize sensor visibility at the API boundary (visible-only `/api/sensors` by default + `include_hidden` debug mode with visibility metadata; map features filtering uses the same policy; removed legacy `hide_live_weather` sensor-config cascade). CI: `cargo test --manifest-path apps/core-server-rs/Cargo.toml` (pass). 2026-01-19: Tier A validated on installed controller `0.1.9.165` (run: `project_management/runs/RUN-20260119-tier-a-cs88-dw152-dw153-dw154-dw155-0.1.9.165.md`). 2026-01-18: Completed CS-85 to add “Derived Sensors” (controller-computed sensors defined by an expression over other sensors) with strict data-integrity constraints (computed series only; no direct ingest into derived sensors; missing inputs yield missing derived buckets). Tier A: installed controller refreshed to `0.1.9.152` (run: `project_management/runs/RUN-20260118-tier-a-cs85-dw144-derived-sensors-0.1.9.152.md`). CI: `make ci-core-smoke` + `make ci-web-smoke` (pass). 2026-01-18: Completed CS-87 to expand the derived-sensor function library (math + trig + conditionals) with strict domain validation (fail closed). Tier A: installed controller refreshed to `0.1.9.162` (run: `project_management/runs/RUN-20260118-tier-a-cs87-dw149-derived-sensor-functions-0.1.9.162.md`). CI: `cargo test --manifest-path apps/core-server-rs/Cargo.toml` (pass). 2026-01-18: Completed CS-86 to audit and enforce sensor-series identity so a single `sensor_id` cannot mix data sources or semantic types/units over time (fail-closed ingest/update guards + ops audit tooling). Tier A: installed controller refreshed to `0.1.9.153` (run: `project_management/runs/RUN-20260118-tier-a-cs86-sensor-series-integrity-0.1.9.153.md`). CI: `make ci-core-smoke` (pass). Health: `make e2e-installed-health-smoke` (pass). 2026-01-17: Completed **CS-84** to enforce WS‑2902 barometric pressure data integrity (no Open‑Meteo/public API backfill into WS-local sensors). Pressure is now split into explicit WS-local sensors (`pressure_relative`, `pressure_absolute`) so the UI is transparent about reference type (relative vs absolute). Tier A: installed controller refreshed to `0.1.9.151` (run: `project_management/runs/RUN-20260117-tier-a-cs84-ws-pressure-integrity-0.1.9.151.md`). CI: `make ci-core-smoke` + `make ci-web-smoke` (pass). 2026-01-18: CS-83’s earlier Open‑Meteo backfill approach was canceled as a data-integrity breach and replaced by CS-84. 2026-01-18: Completed CS-82 to ingest Open‑Meteo current `pressure_msl` as a `pressure` sensor (kPa) for non-local “live weather” sensors (separate from WS-local telemetry). Tier A: installed controller refreshed to `0.1.9.149` (run: `project_management/runs/RUN-20260118-tier-a-dw140-dw141-cs82-0.1.9.149.md`). CI: `make ci-core-smoke` (pass). 2026-01-18: Started CS-80 to harden Pi 5 deploy-over-SSH so clean Raspberry Pi OS Lite images do not require manual SPI enablement for the optional ADS1263 ADC HAT (enable `dtparam=spi=on`, reboot, reconnect, verify). 2026-01-15: Started CS-79 to ensure deleted nodes/sensors stop controller-owned pollers/integrations (Open‑Meteo current weather targets, Forecast.Solar per-node polling, Emporia ingest, WS‑2902 ingest) while retaining history. 2026-01-15: Began on-hardware WS-2902 validation (CS-76), capturing real station upload behavior and confirming controller-side ingest + dashboard rendering gaps to harden against. 2026-01-15: Purged mistaken simulated reservoir depth telemetry for Pi5 Node 1 on the installed controller (OPS-1; run: `project_management/runs/RUN-20260115-ops1-purge-node1-reservoir-depth-sim.md`). 2026-01-14: Implemented CS-75 to shorten WS-2902 ingest tokens and provide a short `/api/ws/<token>` ingest path so vendor “custom server” UIs don’t truncate the configuration; refreshed installed controller to `0.1.9.118` (run: `project_management/runs/RUN-20260114-tier-a-ws2902-short-token-0.1.9.118.md`). On-hardware confirmation is tracked as CS-76. CS-47 is complete: deploy-from-server now supports SSH host key verification (TOFU), secret redaction, and an idempotent “already installed/healthy” outcome while remaining installer-path E2E green. CS-45 is also complete: the core API now provides preset endpoints for WS-2902 weather stations and Renogy BT-2 nodes so the dashboard can do near one-click setup. CS-46 is complete: the core now supports persistent WAN read-only API tokens (DB-backed) that are accepted as bearer auth and cannot pass mutation capability checks. AN-22 is complete: the Rust controller now returns real `reservoir_depth` output from `/api/analytics/water` by deriving a trailing 24h average series from telemetry (`metrics`) and converting units to feet (ft) for compatibility. CS-49 is complete: integration presets are unified into a shared canonical file with a drift check so CLI/core API defaults stay aligned. CS-54 is complete: WS-2902 is explicitly scoped to push-only “custom server uploads” and the dashboard/runbook copy no longer implies controller polling. 2026-01-06: Shipped controller bundle `0.1.9.14` removing production demo analytics fallbacks (snapshot surfaces explicit errors; historical note: `/api/dashboard/demo` was later removed entirely on 2026-02-06). 2026-01-09: Shipped controller bundle `0.1.9.44` adding cache-safe headers for dashboard static assets (HTML `no-store`, fingerprinted assets `immutable`) to prevent stale mobile caches after upgrades. 2026-01-10: Shipped controller bundle `0.1.9.46` restoring `/api/analytics/power` 24h series bucketing to 5-minute intervals (regression fix) so fleet totals align with Emporia’s sampling cadence. 2026-01-10: Shipped controller bundle `0.1.9.48` increasing Renogy solar/storage 24h series to 60-second buckets for higher-fidelity graphs. 2026-01-10: Shipped controller bundle `0.1.9.61` adding dashboard-driven node sensor config push (`/api/nodes/{id}/sensors/config`) that upserts core sensors and syncs to node-agent. 2026-01-10: Validated deploy-from-server on node2 (Debian trixie / Python 3.13) and shipped controller bundle `0.1.9.64` with multi-Python offline deps (py311 + py313). 2026-01-13: Implemented controller-hosted offline map assets + Swanton offline pack workflow and validated on installed controller `0.1.9.112` (run: `project_management/runs/RUN-20260113-tier-a-offline-map-stack-0.1.9.112.md`). 2026-01-13: Wired `/api/connection` to report request path + DB health so the header banner reflects the real API route (`local · online`); validated on installed controller `0.1.9.115` (screenshot: `manual_screenshots_web/20260113_083740/root.png`). 2026-02-01: Fixed Renogy preset apply to merge into the live node-agent config (preserving ADS1263 sensors) and restored Pi5 Node 1 ADC sensors; Tier A refreshed installed controller to `0.1.9.235-adcfix` (run: `project_management/runs/RUN-20260201-tier-a-cs89-renogy-preset-preserve-ads1263-sensors-0.1.9.235-adcfix.md`).

2026-02-18: Completed CS-107 (battery SOC estimator + power runway projection) with migration + config endpoints + read-only virtual sensors; local validation: `make ci-core-smoke` (PASS).

2026-02-18: Tier A validated CS-108 on installed controller `0.1.9.274-battery-runway-fix` (run: `project_management/runs/RUN-20260218-tier-a-cs108-dw258-battery-runway-0.1.9.274-battery-runway-fix.md`; screenshot gate: `make tier-a-screenshot-gate RUN_LOG=project_management/runs/RUN-20260218-tier-a-cs108-dw258-battery-runway-0.1.9.274-battery-runway-fix.md` PASS).

2026-02-08: Tier A validated installed controller refresh for CS-104 (`0.1.9.258-cs104-dhcp-safe`; run: `project_management/runs/RUN-20260208-tier-a-cs104-dhcp-safe-0.1.9.258-cs104-dhcp-safe.md`).

2026-02-03: Secured core API auth gaps (CS-90/91/94/95/96/97): bearer auth + read-scoped capabilities across metrics/backups/core read surfaces, setup credential metadata redaction, dashboard snapshot auth + no scan hot-path, and explicit bootstrap-user-create gating (loopback + env). CI: `make ci-core-smoke`, `make ci-web-smoke`, `make ci-farmctl-smoke` (pass).

2026-02-03: Completed core functional correctness gaps (CS-92/CS-93/CS-98): real backups/restore workflows with a restore worker, DST-safe schedule block evaluation, and predictive trace+bootstrap (no stubbed “success” endpoints). CI: `make ci-core-smoke` (pass).

2026-02-03: Tier A validated installed controller refresh to `0.1.9.244-major-bug-fixes` (no DB/settings reset). Evidence: `project_management/runs/RUN-20260203-tier-a-major-bug-fixes-0.1.9.244-major-bug-fixes.md`.

2026-02-04: Completed CS-99 to support derived sensors with forecast-backed inputs (e.g., weather temperature from `forecast_points`) in historical series queries by teaching the analysis bucket reader to query `forecast_points` for derived inputs (fixes “created sensor history” being blank for temp compensation when a forecast sensor is used). Validation: `make ci-core-smoke` (pass). Tier A validated on installed controller `0.1.9.246-temp-comp-lag` (run: `project_management/runs/RUN-20260204-tier-a-temp-comp-lag-0.1.9.246-temp-comp-lag.md`).

2026-02-04: Completed CS-100 to support per-input `lag_seconds` for derived sensors (lookup input values at `epoch - lag_seconds`) to improve temperature compensation accuracy for thermal-delay sensors. Validation: `make ci-core-smoke` (pass). Tier A validated on installed controller `0.1.9.246-temp-comp-lag` (run: `project_management/runs/RUN-20260204-tier-a-temp-comp-lag-0.1.9.246-temp-comp-lag.md`).

2026-02-04: Completed CS-101 to fix derived sensors with `lag_seconds` becoming empty at coarse bucket intervals (example: Trends 7d uses 30m buckets; if lag is not a multiple of 30m, input lookups miss bucket boundaries). Validation: `make ci-core-smoke` (pass). Tier A validated on installed controller `0.1.9.247-derived-lag-buckets` (run: `project_management/runs/RUN-20260204-tier-a-cs101-derived-lag-buckets-0.1.9.247-derived-lag-buckets.md`).
2026-02-04: Completed CS-102 / DW-218 / DW-219 to allow derived sensors to depend on other derived sensors (derived-of-derived), enabling temperature compensation of already-derived sensors in `/analytics/compensation` and multi-stage derived sensor composition in the Derived Sensor Builder UI. Tier A validated installed `0.1.9.248-derived-of-derived` (run: `project_management/runs/RUN-20260204-tier-a-cs102-dw218-dw219-0.1.9.248-derived-of-derived.md`).

**Notes / Run Log:** 2026-01-10: Node2 (`10.255.8.20`) was running Debian 13 (trixie) with Python 3.13; the original offline overlay shipped only Python 3.11 (cp311) wheels. Resolution shipped multi-Python offline deps (py311 + py313) and validated deploy-from-server on node2 (controller bundle `0.1.9.64`).

Additional confirmed follow-ups are now tracked as tickets: SQL error leakage (RCS-15), OpenTelemetry in core-server-rs (RCS-16), outputs route refactor (RCS-17), preset integration tests (RCS-18), and startup port conflict detection (RCS-19). RCS-18 and RCS-19 are now complete; uninstall cleanup verification/hardening is tracked separately (SETUP-23). 2026-01-23: Added DT-68 to reduce onboarding bloat by splitting bootstrap targets and making Sim Lab / node-agent local simulation an explicit opt-in (while keeping CI/E2E intact).

---

## 2.1 Rust Core Server Migration

**Status:** To Do (RCS-16..RCS-20 follow-ups)

**Description:** Migrate the production controller runtime from the Python core-server + Node-based dashboard server to a single Rust core-server binary that serves both `/api/*` and the dashboard static assets (`/`). The goal is a Rust-first production runtime without rewriting the dashboard UI into Rust/WASM.

**Goals:**
- Serve `/api/*` and `/` (static dashboard build) from one Rust service so auth/sessions/CORS are simpler and launchd manages fewer processes.
- Keep the dashboard as JS/TS static assets (avoid a Rust UI rewrite); Rust SSR/HTMX is acceptable for the setup wizard surface only.
- Use a contract-first workflow: Rust generates/exports the canonical OpenAPI spec and the TS client is generated from it.
- Maintain DB schema parity throughout (shared migrations + side-by-side runs against the same DB during the transition).
- Preserve rollback between bundle versions (upgrade/rollback via the installer gate).

**Recent Progress:** The Rust core-server is the production controller runtime (serves `/api/*` + static dashboard; no Node server process in production). The Rust router implements the full OpenAPI contract and `python3 tools/check_openapi_coverage.py` enforces strict coverage (fails on missing or extra endpoints). The canonical OpenAPI exports from Rust (`python3 tools/api-sdk/export_openapi.py`) and generated SDKs stay aligned via CI drift checks. RCS-14 is complete: the legacy Python FastAPI runtime was removed. 2026-02-12 (ARCH-6): removed the remaining legacy Python `apps/core-server/` tooling surface; DB migrations and demo seed now route through Rust-first tooling (`farmctl db migrate` / `farmctl db seed-demo`, surfaced via `make migrate` / `make seed`). RCS-18 is complete: preset flow coverage is validated via an installer-path integration harness that runs inside the E2E gate. RCS-19 (port conflict detection) is also complete. Post-migration hardening follow-ups remain tracked as RCS-16..RCS-20 (OpenTelemetry, outputs refactor, controller no-Python runtime guardrails). Installer-path validation remains the hard gate (`make e2e-installer-stack-smoke`; log: `reports/e2e-installer-stack-smoke/20260104_050252`).

---

## 3. Node Agent

**Status:** Blocked: hardware validation (generic stack perf + mesh + BLE + Renogy + pulse + ADS1263)

**Description:** This epic covers the development of the agent software that runs on the IoT devices (nodes). The node agent is responsible for collecting sensor data, controlling actuators, and communicating with the core server.

**Goals:**
- Provide a reliable and efficient agent for the IoT devices.
- Ensure all Raspberry Pi 5 nodes ship the same installed software stack (single image/kit); enable/disable features per node via config/capabilities (no per-feature images).
- Ensure Pi 5 installs work on an isolated LAN with **no WAN**: no install-time `apt-get`/`pip` fetches on the Pi; ship required runtime deps and helper daemons inside the controller bundle/kit.
- Support a variety of sensors and actuators.
- Implement a secure and reliable communication protocol with the core server.
- Require auth for node-agent HTTP control-plane endpoints (config/provisioning) and never expose adoption tokens or Wi‑Fi secrets to unauthenticated callers.
- Keep provisioning workflows non-blocking: applying Wi‑Fi credentials must not stall the event loop (avoid watchdog resets / API stalls).
- Ensure restore/apply_config validates persisted settings (especially heartbeat/telemetry intervals) and clamps unsafe values to avoid tight-loop scheduling and fleet-wide instability.
- Prefer maintained MQTT client libraries (aiomqtt) to avoid deprecated dependencies.
- Ship BLE provisioning, mesh networking (zigpy adapter + join/remove + telemetry), and a local UI/CLI to monitor adoption and network health.
- Support dedicated Raspberry Pi 5 charge-controller nodes (Renogy Rover `RNG-CTRL-RVR20-US` via `BT-2` BLE) and provide repeatable deployment tooling for them (GUI-first via the dashboard Deployment UI; no CLI required for non-experts).
- Support a safe “controller settings over Modbus” workflow for Renogy BT‑2 nodes (read current, edit desired, validate/apply with read-back verify, audit history/rollback), orchestrated via the core server and exposed in the dashboard (browser never talks to BLE directly).
- Support 4–20 mA current-loop analog sensors (e.g., reservoir depth transducer) via an ADC module with non-blocking sampling and upstream telemetry publication.
- Enforce non-blocking control-plane behavior: no hardware I/O in HTTP handlers or MQTT callbacks; use bus-owner workers + cached values and keep buffers bounded (design target: event-loop stall <50 ms under load).
- Protect provisioning secrets stored on disk (encrypt Wi-Fi credentials in queues).
- Keep the unit test suite runnable on macOS/Python 3.14 even when DBus/BlueZ are unavailable (test-only shims + graceful skips).

**Recent Progress:** 2026-02-03: Hardened node-agent control plane (NA-66/NA-67/NA-68): bearer-auth config/provisioning endpoints + secret redaction, non-blocking Wi‑Fi apply (no event-loop stalls), and transactional `apply_config` with interval clamping. CI: `make ci-node` (pass), `make ci-core-smoke` (pass). NA-44/NA-45 Pi 5 local display is complete: node-agent now exposes `/display` plus display control APIs, and the controller can push per-node display profile updates from the dashboard (validated via `make ci-node` + `make e2e-web-smoke`). NA-20 mesh adapter + telemetry buffer wiring is implemented with a CLI pairing scaffold (`tools/mesh_pair.py`) that opens join/remove windows and writes pairing artifacts (validated via `make ci-node`). NA-36 de-dupes Pi 5 simulator core registration IDs to avoid seeded DB collisions while keeping Renogy sensor IDs aligned with the node-agent runbook (validated via `make e2e-web-smoke`). NA-28/NA-29 Renogy BT-2 collector + Pi 5 deployment bundle tooling landed; first-boot automation stages bundle configs and can run the in-repo `renogy-bt.service` collector, but physical validation remains pending (simulator telemetry sanity check completed). NA-52 adds a config-driven systemd watcher (`node-agent-optional-services.path`) so updating `node_config.json` automatically enables/disables optional services like `renogy-bt.service` without SSH after install. NA-53 is complete: Pi installs are offline on the Pi (no `apt-get`/`pip` fetches during install) by shipping runtime deps in the controller bundle/kit; real-world offline validation is tracked separately (NA-54). NA-30 added a Raspberry Pi 5 simulator runner for local node-agent testing, and NA-34 extended it with core registration so full-stack E2E uses the core UUID for MQTT topics. NA-31 mapped sensor category types to analog/pulse drivers to avoid unknown-type warnings outside simulation, NA-32 added an external ingest bridge for Renogy payloads, and NA-33 normalized sensor type strings to prevent Sim Lab unknown-type warnings. NA-26 runtime simulation profile controls and NA-27 heartbeat payload list shape are complete with tests passing. NA-43 implemented reservoir depth pressure transducer support (Waveshare ADS1263 HAT + current-loop conversion) with non-blocking sampling helpers and unit coverage; on-device validation is tracked separately (NA-46). NA-47 is complete: the generic Pi 5 node stack baseline now ships the same services everywhere (feature toggles are config-driven) and ships the Renogy collector in-repo; pulse counter implementation is also complete (NA-50). Hardware validation remains tracked separately (NA-48, NA-51). 2026-01-04: Started real Pi 5 Renogy hardware validation (NA-40/NA-41); run log: `reports/prod-pi5-renogy-deploy-20260104_051738.log`. 2026-01-12: Audited the Rover Modbus protocol docs and aligned the node-agent register decode with Table 1 (charging current + packed temps). 2026-01-10: Hardened `/v1/config` apply semantics so empty sensor lists clear sensors, and pruned telemetry publisher scheduling/caches when sensors are removed (NA-59). 2026-01-10: Started the Renogy “controller settings over Modbus” implementation (node-agent writes: NA-60; core orchestration: CS-71; dashboard UI: DW-101); on-device apply validation is tracked separately (NA-61). 2026-01-10: Fixed node-agent BLE provisioning DBus method annotations to run on Python 3.13, and shipped multi-Python offline vendor deps (py311 + py313) so deploy-from-server works on Debian trixie nodes. 2026-01-13: Started NA-46 hardware validation on a real Pi 5 node (Node 1) with ADS1263 HAT + 4–20 mA loop; initial finding: header SPI was disabled and required OS config enablement before ADC reads could succeed. 2026-01-13: Started NA-62 to remove legacy “ADS1115” analog stubs, move ADS1263 GPIO to gpiozero/lgpio, and make analog fail-closed in production with explicit backend/health surfaced in the dashboard (ADR 0005, `TICKET-0032`). 2026-01-14: Completed DT-60 Phase 0 to stabilize the ADS1263 execution plan (`ADC_ADS1263_EXECUTION_PLAN.md`): split work into PH commits, enforce “no rebuild/refresh from uncommitted changes”, and de-conflict ADC docs. 2026-01-15: Fixed Renogy BT‑2 collector discovery so telemetry does not stall after restarts when the device is known to BlueZ but not discoverable by scan (NA-63); Tier A: **user validated visually** (no screenshots). 2026-01-15: Started NA-64 to remove `python3-rpi.gpio` from offline deb staging (Pi 5 incompatibility) and ship `pigpiod` + runtime libs so deploy logs are clean and pulse counters have a real daemon unit on clean installs. 2026-01-17: Fixed ADS1263 GPIO cleanup so failed init does not leak `gpiozero` pin reservations, added SPI auto-detect fallback for stacks exposing SPI as `/dev/spidev10.0`, updated Pi imaging tooling to enable SPI by default, and added a legacy `ads1115` → `analog` alias (validated via `make ci-node` + `python3 tools/node_offline_install_smoke.py`). 2026-01-31: Added Renogy PV energy counters as kWh sensors (today + total) so the dashboard can trend daily and lifetime production; Tier A validated installed controller `0.1.9.231` on Node 1 (nighttime: today is `0.0`).
2026-01-11: Refreshed installed controller to `0.1.9.73` and verified Tier‑A upgrade stability for Renogy settings scaffolding (run: `project_management/runs/RUN-20260111-tier-a-renogy-settings-0.1.9.73.md`). 2026-01-11: Implemented fleet ops health telemetry (per-node latency/jitter/24h reachability uptime + CPU/RAM snapshot) published via node status and surfaced in Nodes/Node detail with trend history; validated on installed controller `0.1.9.77` (run: `project_management/runs/RUN-20260111-tier-a-phase6-fleet-ops-0.1.9.77.md`). 2026-01-11: Nodes drawer UX polish: moved the Local display editor below Outputs and made it collapsible; validated on installed controller `0.1.9.79` (Tier A). 2026-01-11: Fixed Node detail Health history toggle crash on non-localhost origins by adding a SHA-256 fallback and clarified button copy (“health history”); validated on installed controller `0.1.9.80` (Tier A). 2026-01-11: Node detail drawer IA cleanup: consistent card layout + clear hierarchy; validated on installed controller `0.1.9.81` (Tier A).

---

## 4. Discovery and Adoption

**Status:** Done (Tier A validated on installed controller; Tier B clean-host E2E deferred to DT-59)

**Description:** This epic covers the development of the discovery and adoption process for new IoT devices. This includes discovering new devices on the network, assigning them a unique identity, and configuring them for use with the platform.

**Goals:**
- Provide a seamless and user-friendly process for adding new devices to the platform.
- Ensure the security and reliability of the adoption process.

**Recent Progress:** 2026-01-05: Shipped controller-issued adoption tokens only (MAC-bound + TTL) and removed the insecure node-advertised-token fallback that caused `403 Invalid adoption token` in production. Adoption now syncs `http://<node>:9000/v1/config` to register allowlisted Renogy sensors so telemetry ingest starts automatically after adopt; verified on a real Pi 5 Renogy node (see `reports/prod-renogy-node1-fix-20260105_1327.md`). 2026-01-10: Hardened adoption token issuance/adoption to be transaction-safe (row locking + single-use guard) and serialized per-MAC token issuance via Postgres advisory locks to prevent concurrent issuance races. 2026-01-10: Tier A validated adoption token determinism and “reject node-advertised token / accept controller-issued token” semantics on installed controller `0.1.9.70`. Evidence: `project_management/runs/RUN-20260110-tier-a-phase3-adoption-ts8.md`.

---

## 5. Dashboard Web

**Status:** In Progress (Tier A validated on installed controller; Tier B clean-host E2E tracked via cluster tickets)

**Description:** This epic covers the development of the web-based dashboard for the platform. The dashboard provides a user interface for monitoring and controlling the farm.

**Goals:**
- Provide a user-friendly and intuitive interface for the platform.
- Implement all the necessary features for monitoring and controlling the farm.
- Ensure the performance and reliability of the dashboard.
- Enforce UI/UX guardrails for all dashboard changes per `apps/dashboard-web/AGENTS.md` (page pattern + token set, templates/slots, visual hierarchy, component variants, UI debt tracking).
- Make the Map tab offline-first after setup: basemap tiles/glyphs/terrain are served locally by the controller, and interactive nodes/sensors/markup are rendered as MapLibre GeoJSON layers (no DOM markers).
- Make the UI node-first: every sensor/readback/value is clearly scoped to a node (and optional location label), with units displayed consistently.
- Provide a dedicated Power dashboard surface for energy integrations (Renogy + Emporia) **under Analytics** without implying unrelated systems are physically tied together; keep fleet aggregation explicit/opt-in.
- Organize analytical tooling under a single Analytics area (Analytics Overview / Trends / Power) to prevent IA drift and ensure shared time/formatting behavior stays consistent.
- Add operator-facing progress feedback for long-running actions (refresh/scan) and improve perceived responsiveness.
- Surface node fleet health metrics (network latency/jitter/uptime + CPU/RAM) once the node telemetry pipeline publishes them.
- Keep the Vitest/JSDOM test environment stable for Chart.js + download helpers (canvas + ResizeObserver shims).
- Provide a form-based node/sensor config generator for offline/bulk provisioning.
- Support authenticated API mutations via bearer tokens in production.
- Provide a Sim Lab console UI with domain-first monitoring, arm-gated controls, and integration with the Sim Lab control API.

**In Progress:** 2026-02-17: Completed DW-181 completeness-first Related Sensors defaults so runs use backend scope query (`candidate_source=all_sensors_in_scope`) and `evaluate_all_eligible=true` by default; backend evaluate-all is no longer gated to Advanced/eligible<=500. Follow-up corrections landed the same day: Simple mode now defaults to `All nodes`, removed the “Broaden to all nodes” shortcut and Simple-mode “Refine (more candidates)” path, Simple runs no longer use quick-suggest truncation, and evaluate-all runs no longer prefilter away candidates before scoring (plus raised event/co-occurrence candidate ceilings for full-pool execution). Local validation passed: `cargo test --manifest-path apps/core-server-rs/Cargo.toml related_sensors_unified_v2`, `cd apps/dashboard-web && npm test -- --run tests/relatedSensorsOperatorContract.test.tsx tests/relatedSensorsProviderAvailability.test.tsx tests/relatedSensorsWorkflowImprovements.test.tsx tests/relatedSensorsPinnedSemantics.test.tsx`, `cd apps/dashboard-web && npm run build`. Tier A validated installed controllers `0.1.9.269`, correction `0.1.9.270`, and evaluate-all follow-up `0.1.9.271` (runs: `project_management/runs/RUN-20260217-tier-a-dw181-related-sensors-all-scan-0.1.9.269.md`, `project_management/runs/RUN-20260217-tier-a-dw181-simple-all-nodes-correction-0.1.9.270.md`, `project_management/runs/RUN-20260217-tier-a-dw181-evaluate-all-eligible-0.1.9.271.md`; screenshot hard gates PASS). Tier B deferred indefinitely to DW-98 per user instruction. 2026-02-10: Completed DW-249 / TICKET-0058 to apply analysis-default bucket data quality + min-samples gating, surface deterministic bucket coverage/missingness in Related Sensors preview, and render explicit gaps for missing buckets. Tier A validated installed controller `0.1.9.262-dw249-missingness` (run: `project_management/runs/RUN-20260210-tier-a-dw249-missingness-0.1.9.262-dw249-missingness.md`; viewed screenshot: `manual_screenshots_web/tier_a_0.1.9.262-dw249-missingness_unified_preview_2026-02-10_223632415Z/trends_related_sensors_unified_preview.png`); Tier B deferred to DW-98. 2026-02-09: Completed DW-230 to redesign the Trends chart analysis toolbar UX for best-fit clarity: drag-to-select best-fit windows, multi-window fit cards, explicit Save/Update/Delete actions, persisted best-fit hydration (`best_fit_v1` chart annotations), and a desktop-first toolbar with condensed mobile secondary tools. Local validation passed: `make ci-web-smoke`, `cd apps/dashboard-web && npm run test -- trendChartBestFit.test.tsx trendsPage.test.tsx`, `cd apps/dashboard-web && npm run build`. Tier A validated installed controller `0.1.9.259-dw230-trends-bestfit` (run: `project_management/runs/RUN-20260209-tier-a-dw230-trends-bestfit-0.1.9.259-dw230-trends-bestfit.md`; viewed screenshot: `manual_screenshots_web/20260209_005651/trends.png`); Tier B deferred to DW-98. 2026-02-09: Started DW-229 to standardize dashboard-web Highcharts rendering with a shared `HighchartsPanel` wrapper, migrated all direct `HighchartsReact` callsites (TrendChart, AnalyticsShared, MatrixProfile, Correlation Preview/Matrix, Voltage Quality, Compensation charts, Overview sparklines), and added an ESLint guardrail to block new direct `highcharts-react-official` imports outside the wrapper. Local validation passed: `cd apps/dashboard-web && npm run lint`, `cd apps/dashboard-web && npm run test -- tests/highchartsPanel.test.tsx`, `cd apps/dashboard-web && npm run test -- tests/trendsPage.test.tsx`, `cd apps/dashboard-web && npm run test -- tests/smoke.test.ts`, `cd apps/dashboard-web && npm run build`. Tier A pending. 2026-02-09: Started DW-228 to align Trends `Pattern & Anomaly Detector` chart-card layout with the Related Sensors context graph format and expanded Related Sensors `Context` presets (`±1h`, `±3h`, `Custom…` with `Custom ±hours` numeric input). Implemented in `MatrixProfilePanel.tsx` and `relationshipFinder/PreviewPane.tsx`. Local validation passed: `cd apps/dashboard-web && npm run lint`, `cd apps/dashboard-web && npm run test -- tests/trendsPage.test.tsx`, `cd apps/dashboard-web && npm run test -- tests/smoke.test.ts`, `cd apps/dashboard-web && npm run build`. Tier A pending. 2026-02-09: Started DW-227 to fix Trends sensor picker checkbox parity so sensor selection works via both row click and checkbox click without double toggles. Implemented a shared selection-toggle path in `TrendsPageClient` and updated picker checkbox/label event handling. Local validation passed: `cd apps/dashboard-web && npm run test -- tests/trendsPage.test.tsx`, `cd apps/dashboard-web && npm run test -- tests/smoke.test.ts`. Tier A pending. 2026-02-06: Completed DW-221 to implement a full Related Sensors v2 refresh with a single Rust backend job (`related_sensors_unified_v2`) that blends event-match + co-occurrence scoring and emits confidence tiers/evidence summaries, plus a unified dashboard Simple/Advanced UX (quick suggest + refine, insight cards, unified preview). Local validation passed: `cargo test --manifest-path apps/core-server-rs/Cargo.toml`, `cargo test --manifest-path apps/core-server-rs/Cargo.toml services::analysis::jobs::related_sensors_unified_v2::tests`, `cd apps/dashboard-web && npm run lint`, `cd apps/dashboard-web && npm run test:smoke`. Tier A validated installed `0.1.9.251-related-unified-v2` (run: `project_management/runs/RUN-20260206-tier-a-dw221-related-sensors-unified-0.1.9.251-related-unified-v2.md`; viewed screenshots: `manual_screenshots_web/tier_a_0.1.9.251_dw221_related_sensors_unified_20260206_0023/trends_related_sensors_large_scan.png`, `manual_screenshots_web/tier_a_0.1.9.251_dw221_related_sensors_unified_20260206_0023/trends_related_sensors_scanning.png`); Tier B deferred to DW-98. 2026-02-06: Completed DW-222 to prevent sparse single-point candidate previews when lag alignment over-shifts timestamps in Trends Related Sensors; preview now auto-falls back to raw candidate data when aligned series is too sparse and shows explanatory UI copy. Tier A validated installed `0.1.9.252-preview-fallback` (run: `project_management/runs/RUN-20260206-tier-a-dw222-preview-fallback-0.1.9.252-preview-fallback.md`; viewed screenshots: `manual_screenshots_web/20260206_015437/trends_related_sensors_large_scan.png`, `manual_screenshots_web/20260206_015437/trends_related_sensors_scanning.png`); Tier B deferred to DW-98. 2026-02-06: Completed DW-223/DW-224 on installed controller `0.1.9.254-matrix-refresh-fix`: Related Sensors Simple mode now renders a matrix-first view driven by score cutoff (`blended_score >= cutoff`, cap 25 related sensors), Trends includes a separate Selected Sensors correlation matrix card outside Related Sensors, and a follow-up fix removed repeated matrix submits that caused layout jitter. Validation: `cd apps/dashboard-web && npm run lint`, `cd apps/dashboard-web && npm run test:smoke`, `cd apps/dashboard-web && npm test -- --run tests/correlationMatrixSelection.test.ts`, `cd apps/dashboard-web && npm run build`, `make ci-web-smoke`, `make e2e-installed-health-smoke` (pass). Tier A run: `project_management/runs/RUN-20260206-tier-a-dw223-dw224-matrix-refresh-fix-0.1.9.254-matrix-refresh-fix.md`; viewed screenshots: `manual_screenshots_web/20260206_025805/trends_related_sensors_scanning.png`, `manual_screenshots_web/20260206_025805/trends_selected_sensors_matrix_card_result.png`. Tier B deferred to DW-98. 2026-02-04: Completed DW-216 to improve Analytics → Temp Compensation fitting for reservoir-depth-style sensors by optionally detrending slow time changes (to avoid diluting temperature coefficients) and adding a fit diagnostics panel; validation: `make ci-web-smoke-build` (pass) and `cd apps/dashboard-web && npm test -- --run tests/tempCompensation.test.ts` (pass). 2026-02-02: Completed DW-213 to fix a mobile WebKit crash when Highcharts zoom is disabled (avoid `chart.zooming: undefined` overrides); Tier A refreshed installed controller to `0.1.9.240-highcharts-zooming-fix` (run: `project_management/runs/RUN-20260202-tier-a-dw213-highcharts-zooming-fix-0.1.9.240-highcharts-zooming-fix.md`). 2026-02-02: Completed DW-211 to add an Analytics “temperature drift compensation” wizard that fits correction factors from historical data and creates a derived compensated sensor; Tier A refreshed installed controller to `0.1.9.239-temp-compensation` (run: `project_management/runs/RUN-20260202-tier-a-dw211-temp-compensation-0.1.9.239-temp-compensation.md`; screenshot: `manual_screenshots_web/tier_a_0.1.9.239_dw211_temp_compensation_20260202_014033/analytics_compensation.png`); Tier B clean-host E2E deferred to DW-212. 2026-02-02: Completed DW-207 to make Trends Key panels collapsed by default. Tier A validated installed controller `0.1.9.237-trends-keys` with viewed screenshot `manual_screenshots_web/tier_a_0.1.9.237_trends_keys_20260202_211900/trends.png`. 2026-02-03: Completed DW-210 to prevent Related Sensors result selection from jumping back to rank 1 during background polling refreshes; Tier A refreshed installed controller to `0.1.9.242-dw210-related-selection` (run: `project_management/runs/RUN-20260203-tier-a-dw210-related-sensors-selection-0.1.9.242-dw210-related-selection.md`; screenshots: `manual_screenshots_web/tier_a_0.1.9.242_dw210_related_selection_20260203_020057Z/*`). 2026-02-03: Completed DW-215 to fix a Trends Sensor picker overflow regression (sidebar content painting outside its card after CollapsibleCard layout changes); Tier A refreshed installed controller to `0.1.9.243-dw215-sensor-picker-overflow` (run: `project_management/runs/RUN-20260203-tier-a-dw215-sensor-picker-overflow-0.1.9.243-dw215-sensor-picker-overflow.md`; viewed screenshot: `manual_screenshots_web/tier_a_0.1.9.243_dw215_sensor_picker_overflow_20260203_071210Z/trends.png`); Tier B deferred to DW-98. 2026-02-02: Started DW-208 to default-open the Analytics Overview Soil moisture card (local validation; Tier A pending). 2026-02-02: Started DW-209 to fix Analytics Overview mobile overflow (cards expand to fit charts without narrowing), migrate the 24h/72h/7d range selector to shadcn/ui styling, and enable mobile pinch-zoom out without forcing desktop breakpoints; Tier A refreshed installed controller to `0.1.9.241-analytics-mobile-window` (run: `project_management/runs/RUN-20260202-tier-a-dw209-dw214-0.1.9.241-analytics-mobile-window.md`; WebKit screenshots (**viewed**): `manual_screenshots_web/tier_a_0.1.9.241_dw209_pinchzoom_20260202_211214Z/*`; installed smoke: `make e2e-installed-health-smoke` (pass); pending on-device pinch-zoom confirmation). 2026-02-02: Completed DW-214 to add a custom training window (start/end) to Analytics → Temp Compensation; Tier A validated installed controller `0.1.9.241-analytics-mobile-window` (run: `project_management/runs/RUN-20260202-tier-a-dw209-dw214-0.1.9.241-analytics-mobile-window.md`; WebKit screenshots (**viewed**): `manual_screenshots_web/tier_a_0.1.9.241_dw214_comp_custom_range_20260202_211125Z/*`; Tier B deferred to DW-212). 2026-02-01: Completed DW-206 to increase the Trends default Trend chart height (migrating legacy persisted defaults). Tier A validated installed controller `0.1.9.236-trends-height` with viewed screenshot `manual_screenshots_web/tier_a_0.1.9.236_trends_height_20260201_143200/trends.png`. 2026-01-31: Completed DW-202..DW-205 to eliminate recurring dev auth + screenshot workflow friction (ADR-0007; ticket: `project_management/tickets/TICKET-0047-dashboard-web-dev-auth-and-screenshots-auto-login-port-discovery-stub-fallback.md`; evidence: `manual_screenshots_web/20260131_dev_auth_workflow_*`). 2026-01-22: Started DW-181 to default Trends → Related sensors to scan all candidates by default (removes the hard-coded 300 cap). 2026-01-22: Added DW-182/DW-183 to refactor Setup Center setup-daemon API calls into typed modules and extract shared validation helpers. 2026-01-22: Added DW-185 to extract Setup Center CollapsibleCard sections into `setup/sections/*.tsx` components (props-driven; no UI drift). 2026-01-22: Added DW-186 to guard Setup Center Integrations actions behind `config.write` (disable mutation controls for view-only users). 2026-01-22: Started DW-185 by extracting the Offline Maps section into `OfflineMapsSection.tsx` (offline pack query/summary/install UI). 2026-01-22: Added `HyperlocalWeatherSection.tsx` + `SolarPvForecastSection.tsx` for the Setup Center forecast cards (wired into `SetupPageClient` via shared setup API modules + validation helpers; `make ci-web-smoke` and `cd apps/dashboard-web && npm run build` pass). 2026-01-22: Added `IntegrationsSection.tsx` + `AiAnomalyDetectionSection.tsx` for Setup Center tokens/Emporia + predictive config UI (wired into `SetupPageClient` and guarded mutations behind `config.write`; `make ci-web-smoke` and `cd apps/dashboard-web && npm run build` pass). 2026-01-22: Started DW-187 to de-bloat Analytics Overview (`AnalyticsOverview.tsx`) by extracting sections/components and consolidating shared helpers (no UX regressions). 2026-01-22: Audited helper consolidation in Analytics Overview/Power/Setup pages; confirmed shared `sensorOrigin`/`powerSensors` usage and noted minor follow-ups (`Ws2902SensorBuilder` `configString`, Trends `sensorSourceBucket`). 2026-01-22: Continued DW-187 by wiring Analytics Overview WeatherStation/Status to use shared `useAnalyticsData` (dedupe nodes/sensors queries). 2026-01-22: Extracted Analytics weather station UI + shared chart helpers into new component files (pending wiring into `AnalyticsOverview.tsx`). 2026-01-22: Extracted Analytics PV forecast section into `PvForecastSection.tsx` and added a PV windowing helper + unit test (`apps/dashboard-web/tests/pvForecastHelpers.test.ts`). 2026-01-22: Completed DW-187 (AnalyticsOverview module split + shared analytics data layer + shared helpers); `make ci-web-smoke`, `cd apps/dashboard-web && npm run build`, and `cd apps/dashboard-web && npm test` pass. 2026-01-22: Completed DW-188 to make Related sensors scans usable at 7d + 1m by adaptively splitting metrics queries and adding large-scan confirm/progress/cancel UX (Tier A validated 0.1.9.198; run: `project_management/runs/RUN-20260122-tier-a-dw188-related-sensors-week-1m-0.1.9.198.md`). 2026-01-23: Completed DW-189/DW-190/DW-191 Map refactor (offline pack install/progress dedupe, derived data hook, MapPageClient decomposition). Tier A refreshed installed controller to `0.1.9.199` (run: `project_management/runs/RUN-20260123-tier-a-dw189-dw190-dw191-map-refactor-0.1.9.199.md`; screenshots: `manual_screenshots_web/20260122_211457/map.png`; installed smoke: `make e2e-installed-health-smoke` (pass)). 2026-01-24: Added DW-193 to add a Playwright Chromium desktop project for dashboard-web coverage. 2026-01-30: Completed DW-195 (shadcn Phase 3 gray→token migration + dead code pruning). Added DW-196 (shadcn Phase 5 component upgrades) to To Do. 2026-01-31: Started DW-197 to add an interactive Trends “line of best fit” tool (mouse-selected window endpoints) and polish the graph analysis tools UX. 2026-01-31: Completed DW-198 Trends chart analysis toolbar (custom palette wired to Highcharts navigation bindings + persisted annotations); Tier A validated installed controller `0.1.9.229` (run: `project_management/runs/RUN-20260131-tier-a-dw198-trends-chart-analysis-toolbar-0.1.9.229.md`). 2026-01-31: Completed DW-199 to fix a Sensors & Outputs sensor-drawer crash caused by Highcharts stock-tools bindings; Tier A validated installed controller `0.1.9.231` (run: `project_management/runs/RUN-20260131-tier-a-na65-renogy-kwh-sensors-0.1.9.231.md`). 2026-01-31: Started DW-200 to make mobile horizontal overflow reachable (avoid clipped content on small screens while preserving desktop layout). 2026-01-31: Started DW-201 to fix the Sensors & Outputs overlapping/garbled layout regression. 2026-01-31: Fixed the Sensors & Outputs overlap regression by correcting `CollapsibleCard` overflow behavior; validated via `make ci-web-smoke` (pass) and screenshot `manual_screenshots_web/sensors_overlap_debug_after3/sensors.png`.

**Recent Progress:** 2026-02-10: Completed DW-246 (diurnal/periodic mitigation: deseasoning + low-entropy penalty), DW-247 (optional `Δ corr` evidence/signal), and DW-248 (correlation block list-first default + deltas/lag modes). Local validation passed: `cargo test --manifest-path apps/core-server-rs/Cargo.toml`, `make ci-web-smoke`, `cd apps/dashboard-web && npm test -- --run tests/relatedSensorsAdvancedMitigationControls.test.tsx tests/relatedSensorsCorrelationBlockRefinements.test.tsx`, `cd apps/dashboard-web && npm run build`. Tier A pending; Tier B deferred to DW-98.

**Recent Progress:** 2026-02-04: Completed DW-217 (Temp Compensation: temperature lag auto/custom) and CS-100 (derived sensor inputs: `lag_seconds`) to address under-compensation caused by thermal delay. Tier A validated on installed controller `0.1.9.246-temp-comp-lag` (run: `project_management/runs/RUN-20260204-tier-a-temp-comp-lag-0.1.9.246-temp-comp-lag.md`; viewed screenshot: `manual_screenshots_web/20260204_041605_temp_comp/analytics_compensation_temp_lag.png`). Local validation: `make ci-core-smoke` (pass) and `make ci-web-smoke-build` (pass).

**Recent Progress:** 2026-01-30: Completed DW-195 shadcn Phase 3 completion + dead code pruning — migrated 1,571 hard-coded gray Tailwind classes to design token equivalents across 109 `.tsx` files, deleted 9 dead provisioning files (zero importers), and de-exported 8 unused symbols across 3 files. `npm run lint && npm run test:smoke && npm run build` pass. Added DW-196 (shadcn Phase 5 component upgrades) to To Do.

**Recent Progress:** 2026-01-24: Completed DW-194 to expand Trends analysis Key jargon (TSSE/MAD/F1/r/n) and Tier A validated on installed controller `0.1.9.213` (run: `project_management/runs/RUN-20260124-tier-a-dw194-trends-key-jargon-0.1.9.213.md`).

**Recent Progress:** 2026-01-23: Added a concise Map tab upgrade smoke checklist for refactor validation (`docs/qa/map-tab-upgrade-smoke.md`).

**Recent Progress:** 2026-01-22: Completed DW-184 to add Setup Center parser/validator unit tests for config parsing and validation helpers (Vitest).

**Recent Progress:** 2026-01-21: Completed DW-180 to expand Trends Range/Interval presets for short-window, high-resolution analysis (add Last 10 minutes + Last hour, add 1s + 30s; remove 180d, 15m, 2h; allow custom min 1s). Tier A validated on installed controller `0.1.9.195` (run: `project_management/runs/RUN-20260121-tier-a-dw180-trends-range-interval-presets-0.1.9.195.md`). Tier B deferred to `DW-98`.

**Recent Progress:** 2026-01-21: Completed DW-179 to add a WS‑2902 weather station “Add sensor” flow (preset-first + Advanced) so operators can map custom station upload fields (e.g., soil moisture) into first-class sensors across the dashboard. Tier A validated on installed controller `0.1.9.194` (run: `project_management/runs/RUN-20260121-tier-a-dw179-weather-station-add-sensors-0.1.9.194.md`). Tier B deferred to `DW-98`.

**Recent Progress:** 2026-01-21: Completed DW-178 to add a Trends “Co-occurring anomalies” panel (focus-scan + multi-sensor mode) that surfaces timestamps where multiple sensors spike/change together (extra weight for larger groups), with in-section Keys and Trend chart markers. Tier A validated on installed controller `0.1.9.193` (run: `project_management/runs/RUN-20260121-tier-a-dw178-trends-cooccurring-anomalies-0.1.9.193.md`). Tier B deferred to `DW-98`.

**Recent Progress:** 2026-01-20: Completed DW-177 to increase Trends overlay limit (allow >10 series; raise max selection to 20) so operators can compare more sensors at once. Tier A validated on installed controller `0.1.9.188` (run: `project_management/runs/RUN-20260120-tier-a-dw177-trends-overlay-limit-0.1.9.188.md`). Tier B deferred to `DW-98`. 2026-01-20: Completed DW-176 to add an optional Savitzky–Golay smoothing/derivative mode to Trends (toggle + advanced settings; visualization-only; preserves gaps). Tier A validated on installed controller `0.1.9.187` (run: `project_management/runs/RUN-20260120-tier-a-dw176-trends-savgol-smoothing-0.1.9.187.md`). Tier B deferred to `DW-98`. 2026-01-19: Completed DW-157 to add persistent drag-and-drop display ordering for nodes + sensors (stored in the controller DB; enforced at the API/UI boundary so all tabs stay consistent). Tier A validated on installed controller `0.1.9.168` (run: `project_management/runs/RUN-20260119-tier-a-dw157-display-order-0.1.9.168.md`). Tier B deferred to `DW-114`/`DW-98`. 2026-01-19: Completed DW-156 to extend Trends “Related sensors” beyond continuous correlation by adding an event/spike comparison mode (co-occurrence + lag), optional conditioning bins (“irradiance ≈ constant”), and per-panel analysis keys defining `n`/`r`/lag/score/window. Tier A validated on installed controller `0.1.9.166` (run: `project_management/runs/RUN-20260119-tier-a-dw156-trends-events-analysis-keys-0.1.9.166.md`). CI: `make ci-web-smoke` (pass); build: `cd apps/dashboard-web && npm run build` (pass). 2026-01-18: Completed DW-148 to add Trends “Related sensors” auto-compare suggestions + previews (ticket: `project_management/tickets/TICKET-0035-trends-auto-compare-related-sensor-suggestions.md`). Tier A: installed controller refreshed to `0.1.9.160` (run: `project_management/runs/RUN-20260118-tier-a-dw148-trends-auto-compare-0.1.9.160.md`). CI: `make ci-web-smoke` (pass). 2026-01-18: Completed DW-149 to expand the Derived sensor builder’s function library + insert helpers (aligns with CS-87). Tier A: installed controller refreshed to `0.1.9.162` (run: `project_management/runs/RUN-20260118-tier-a-cs87-dw149-derived-sensor-functions-0.1.9.162.md`). CI: `make ci-web-smoke` (pass). 2026-01-18: Completed DW-150 to show sensor origin badges in Trends (matching Sensors & Outputs) and add a “hide external sensors” toggle for public-API-backed sensors (ticket: `project_management/tickets/TICKET-0037-trends-show-sensor-origin-badges-hide-external-toggle.md`). Tier A: installed controller refreshed to `0.1.9.163` (run: `project_management/runs/RUN-20260118-tier-a-dw150-trends-origin-badges-0.1.9.163.md`). CI: `make ci-web-smoke` (pass). 2026-01-18: Completed DW-147 to add an Alarm Events drilldown (click-through detail drawer + context charts) so operators can inspect event metadata and see the underlying telemetry that triggered the alarm (ticket: `project_management/tickets/TICKET-0034-alarm-event-drilldown-details-and-charts.md`). Tier A: installed controller refreshed to `0.1.9.158` (run: `project_management/runs/RUN-20260118-tier-a-dw147-alarm-event-drilldown-0.1.9.158.md`). CI: `make ci-web-smoke` (pass). 2026-01-18: Completed DW-146 to fix Overview “Telemetry tapestry” layout regressions (hover jank + horizontal overflow) and add deterministic Playwright coverage (ticket: `project_management/tickets/TICKET-0033-overview-telemetry-tapestry-layout-regressions.md`). Tier A: installed controller refreshed to `0.1.9.157` (run: `project_management/runs/RUN-20260118-tier-a-dw146-overview-tapestry-layout-0.1.9.157.md`). CI: `make ci-web-smoke` (pass). 2026-01-18: Completed DW-145 to add a Trends chart height control (persisted locally) so operators can resize plots taller for easier inspection. Tier A: installed controller refreshed to `0.1.9.156` (run: `project_management/runs/RUN-20260118-tier-a-dw145-trends-chart-height-0.1.9.156.md`). CI: `make ci-web-smoke` (pass). 2026-01-18: Completed DW-144 to add a Derived Sensor builder in the Sensors & Outputs “Add sensor” drawer (expression-based computed sensors with clear provenance/inputs), plus derived-definition transparency in Sensor detail. Tier A: installed controller refreshed to `0.1.9.152` (run: `project_management/runs/RUN-20260118-tier-a-cs85-dw144-derived-sensors-0.1.9.152.md`). CI: `make ci-web-smoke` (pass). 2026-01-18: Completed DW-142 (node type badges across primary node-title surfaces) and DW-143 (Sensors & Outputs never auto-expands a node on navigation, including filtered views/deep links). Tier A: installed controller refreshed to `0.1.9.150` (run: `project_management/runs/RUN-20260118-tier-a-cs83-dw142-dw143-0.1.9.150.md`). CI: `make ci-web-smoke` (pass). 2026-01-18: Completed DW-141 (Sensors & Outputs default collapse) and DW-140 (Trends renders sparse series + surfaces “last value / last seen” when empty). Tier A: installed controller refreshed to `0.1.9.149` (run: `project_management/runs/RUN-20260118-tier-a-dw140-dw141-cs82-0.1.9.149.md`). CI: `make ci-web-smoke` (pass). 2026-01-16: Completed DW-132 to fix dashboard numeric input UX by introducing a shared draft-based numeric input component (decimals, intermediate range typing, negative sign support) and migrating numeric offenders across the dashboard. Validation: `cd apps/dashboard-web && CI=1 npm test` (pass), `cd apps/dashboard-web && npm run build` (pass). Tier‑A installed-controller screenshot validation completed as DW-134 (run: `project_management/runs/RUN-20260116-tier-a-dw134-numeric-input-0.1.9.142.md`). 2026-01-16: Completed DW-135..DW-138 (Analytics weather station panel, alarm events collapse, water depth gauge scale to 15 ft, and Overview local sensor config) with Tier‑A validation on installed controller `0.1.9.143`..`0.1.9.146` (runs: `project_management/runs/RUN-20260116-tier-a-dw135-analytics-weather-station-0.1.9.143.md`, `project_management/runs/RUN-20260116-tier-a-dw136-alarm-events-collapse-0.1.9.144.md`, `project_management/runs/RUN-20260116-tier-a-dw137-analytics-water-depth-scale-0.1.9.145.md`, `project_management/runs/RUN-20260116-tier-a-dw138-overview-local-sensors-config-0.1.9.146.md`). 2026-01-16: Completed DW-139 to add a Trends Matrix Profile explorer (motifs + anomalies + self-similarity heatmap), validated on installed controller `0.1.9.147` (run: `project_management/runs/RUN-20260116-tier-a-dw139-trends-matrix-profile-0.1.9.147.md`). 2026-01-15: Completed DW-131 to fix Analytics reservoir depth mislabeling (depth shown on gallons charts) by splitting depth sensors into a dedicated depth graph + adding a rich “live reservoir depths” companion visualization with full-range gauges. Tier‑A validated on installed controller `0.1.9.141` (run: `project_management/runs/RUN-20260115-tier-a-dw131-analytics-water-depth-0.1.9.141.md`). 2026-01-15: Completed DW-130 to add Overview-only, feature-rich visualizations highlighting locally acquired sensors (exclude forecast/public API sensors) using custom components (not recycled from Trends). Tier‑A validated on installed controller `0.1.9.140` (run: `project_management/runs/RUN-20260115-tier-a-dw130-overview-local-visualizations-0.1.9.140.md`). 2026-01-15: Completed DW-129 to fix the Map tab layout so the map canvas and right-side panels fill the viewport height (no “3/4 height” gap) while keeping the mobile UX usable. Tier‑A validated on installed controller `0.1.9.139` (run: `project_management/runs/RUN-20260115-tier-a-dw129-map-viewport-fill-0.1.9.139.md`). 2026-01-15: Completed DW-122/DW-123 to consolidate detail UX (node detail drawer → node detail page; sensor detail page → sensor detail drawer + `/sensors/detail` redirect) and updated cross-tab links (including Map). Tier‑A validated on installed controller `0.1.9.126` (run: `project_management/runs/RUN-20260115-tier-a-dw122-dw123-detail-ux-0.1.9.126.md`). 2026-01-15: Completed DW-119 Map navigation crash fix (no “Application error” when navigating away from Map), Tier‑A validated on installed controller `0.1.9.127` (run: `project_management/runs/RUN-20260115-tier-a-dw119-map-nav-0.1.9.127.md`). 2026-01-15: Completed DW-118 (node soft delete UI) and DW-124 (sensor soft delete UI) with backend enforcement so soft-deleted entities disappear from Nodes/Sensors/Trends/Map and names are reusable; Tier‑A validated on installed controller `0.1.9.132` (run: `project_management/runs/RUN-20260115-tier-a-soft-delete-node-sensor-0.1.9.132.md`). 2026-01-15: Completed DW-126 to allow per-node hiding of live weather (Open‑Meteo) sensors in the dashboard UI while continuing to store the data; Tier‑A validated on installed controller `0.1.9.134` (run: `project_management/runs/RUN-20260115-tier-a-hide-live-weather-0.1.9.134.md`). 2026-01-15: Completed DW-127 to add “Acknowledge all alerts” actions on alarm-event panels (Sensors & Outputs + Nodes) with a bulk-ack backend endpoint; Tier‑A validated on installed controller `0.1.9.135` (run: `project_management/runs/RUN-20260115-tier-a-ack-all-alerts-0.1.9.135.md`). 2026-01-15: Completed DW-128 to fix Overview Mermaid diagram edge rendering (no filled arrow wedges; stroke-only edges); Tier‑A validated on installed controller `0.1.9.137` (run: `project_management/runs/RUN-20260115-tier-a-overview-mermaid-0.1.9.137.md`).

**Recent Progress:** 2026-01-14: Started DW-118 to add an admin-only soft delete action for nodes in the dashboard UI. Also started DW-119..DW-121 to harden Map navigation (avoid client-side exceptions on route transitions), add direct links to node/sensor detail pages, and add a weather station “Rotate token / setup” entrypoint on weather station nodes (via CS-77 by-node WS-2902 endpoints). DW-49 is complete: the dashboard can now edit per-node display profiles (enable/disable kiosk, select tiles/trends, optional output controls) and push them to nodes via the core API (validated via `make ci-web-smoke` + `make e2e-web-smoke`). Sim Lab console now uses domain-first panels with arm-gated control API wiring; CNC styling retained without joystick/g-code metaphors. Remote Pi 5 deployment UI is live, and the Sim Lab smoke backup-restore step now targets the correct node for deterministic runs. DW-47 and DW-48 are complete: the (now-deprecated) provisioning config generator and schedule builder were split into focused hooks/components while keeping web + installer-path E2E green. DW-52 hardens the deployment UX (host key verification + idempotent outcomes), DW-51 adds WS-2902 one-click setup, and DW-50 adds Renogy BT-2 one-click setup from the node detail surface. DW-53 is complete: a read-only static dashboard build (`npm run build:wan`) disables mutation helpers and surfaces WAN pull-agent sync status via `/api/portal/status`. 2026-01-05: Shipped the adopt-flow fix so the dashboard always uses controller-issued adoption tokens (no advertised-token fallback) and surfaces real token issuance errors; verified on a real Pi 5 Renogy node (see `reports/prod-renogy-node1-fix-20260105_1327.md`). 2026-01-06: Shipped controller bundle `0.1.9.14` removing demo/fake UI fallbacks for analytics and API outages (production shows explicit error/unavailable states only). 2026-01-07: Implemented DW-61 map tab (MapLibre + persisted nodes/sensors/custom hardware placement + polygon/overlay tooling) and shipped in controller bundle `0.1.9.20`; 0.1.9.21 adds on-map labels for drawn markup; 0.1.9.25 adds layer attributions + placed/unplace management for nodes/sensors; 0.1.9.26 added an experimental Mapillary Street View mode (later removed; this project does not require street-level imagery). 2026-01-12: Map tab now shows “Viewport height” (what you can actually see on screen) and “Zoom to ~300′” targets that metric; complex markup edits no longer spam backend writes during vertex drags. 2026-01-12: Trends custom range now supports explicit Start/End datetime selection for historic analysis windows (no freeform single-box duration input). 2026-01-12: Restored a minimal sensor list in the Node drawer with a deep-link into Sensors & Outputs, plus a Playwright regression test (`playwright/node-drawer-sensor-deeplink.spec.ts`). 2026-01-12: Removed the separate Provisioning tab entry point and made Deployment the end-to-end flow (deploy over SSH → adopt by MAC → configure sensors), validated on the installed controller bundle `0.1.9.97` with screenshots under `manual_screenshots_web/tier-a-0.1.9.97-deployment-adopt/`. 2026-01-13: Added Chart.js x-axis pan/zoom + double-click reset across all graphs using `chartjs-plugin-zoom`, validated on the installed controller bundle `0.1.9.114` with screenshots under `manual_screenshots_web/tier_a_0.1.9.114_chart_zoom_pan/`. 2026-01-07: Added DW-69 dev-activity banner plumbing (TTL marker + `/api/dev/activity`) and shipped in controller bundle `0.1.9.28` so operators can see when automated changes are actively in progress. 2026-01-11: Tier‑A revalidated Phase 5 operator surfaces and closed DW‑57/DW‑60/DW‑66/DW‑67/DW‑70 under the installed controller bundle `0.1.9.75` (Tier‑B validation deferred to cluster tickets); evidence: `project_management/runs/RUN-20260111-tier-a-phase5-operator-surfaces-0.1.9.75.md`. 2026-01-12: Tier‑A dashboard tab audit + cross-tab header/banner consistency sweep validated on installed controller `0.1.9.103` with Playwright screenshots captured + viewed for each tab (run: `project_management/runs/RUN-20260112-tier-a-dashboard-tab-audit-0.1.9.103.md`). 2026-01-13: Made Map offline-first after setup with controller-hosted tiles/glyphs/terrain + Swanton pack install UX; Tier‑A validated on installed controller `0.1.9.112` with browser-level internet blocked (run: `project_management/runs/RUN-20260113-tier-a-offline-map-stack-0.1.9.112.md`). 2026-01-13: Hardened hardware sensor configuration UX so only Pi node-agent nodes expose “Add sensor”, and the core API rejects hardware sensor config updates for non-node-agent nodes (Tier‑A validated installed controller `0.1.9.113`; run: `project_management/runs/RUN-20260113-tier-a-hardware-sensors-pi-only-0.1.9.113.md`).
2026-01-12: Canonicalized user roles end-to-end (`admin`/`operator`/`view`) and capability-gated admin navigation + Users/Outputs actions (so operators don’t see controls that always fail). Validated on installed controller `0.1.9.101` with Tier‑A screenshots under `manual_screenshots_web/tier_a_auth_0.1.9.101_20260112_1725/` and run log `project_management/runs/RUN-20260112-tier-a-auth-permissions-0.1.9.101.md`.
2026-01-12: Nodes tab detail drawer now includes an editable Location (lat/lng) section (saved into node config for weather/PV features) and uses the label “More details” for opening the drawer. Tier‑A validated on installed controller `0.1.9.102`; evidence: `project_management/runs/RUN-20260112-tier-a-node-location-0.1.9.102.md`.
2026-01-12: Added Emporia/Renogy voltage quality panels (AC + DC) with Playwright coverage; Tier‑A validated on installed controller `0.1.9.103` (run: `project_management/runs/RUN-20260112-tier-a-dashboard-tab-audit-0.1.9.103.md`).
2026-01-11: Updated Overview “Where things live” to a Mermaid sitemap with hover tooltips and clickable navigation (DW-105); validated on installed controller `0.1.9.87` (Tier‑B deferred to DT‑59).
2026-01-08: Extended Setup Center’s Emporia panel to list all meters on the account, allow grouping by address, and allow excluding specific meters from system-wide power summaries without hiding them from node/power views; Analytics now shows an “Emporia meters by address” breakdown. Shipped in controller bundle `0.1.9.29` (tests pending due to the clean-state gate).
2026-01-08: Implemented DW-71..DW-77 follow-ups (Map tab basemap blank fix, named map saves, per-node live weather from active map placement, offline duration labels, Analytics layout/table fixes, Trends independent-axis mapping UX, node/sensor rename + per-sensor decimals + bulk set). Added AN-33/AN-34 (cloud cover forecast + current weather endpoint) for weather panels. Tests pending due to the clean-state gate on this host.
2026-01-20: Completed DW-164 to replace Trends “AnalysisKey” popovers with inline, bottom-anchored help keys that always show a short overview and expand/collapse for details. Tier A validated on installed controller `0.1.9.175` (run: `project_management/runs/RUN-20260120-tier-a-dw164-trends-inline-help-keys-0.1.9.175.md`). Tier B deferred to `DW-98`.
2026-01-08: PV forecast Analytics UX follow-up: removed the redundant daily energy plot for the Public plan and expanded the PV overlay chart to a 48h window (past forecast accuracy + next 24h forecast) (DW-81); refreshed installed controller to `0.1.9.40`. Tests pending due to the clean-state gate on this host.
2026-01-08: Enforced light-only UI rendering (disabled dark-mode styling and switched Tailwind `dark:` variant to class-based) to avoid dark-mode rendering issues in Schedules (DW-82); refreshed installed controller to `0.1.9.41`. Tests pending due to the clean-state gate on this host.
2026-01-08: Trends tab now includes longer range presets (2w..1y) and auto-selects interval buckets when the range changes; expanded `/api/metrics/query` max window to 365 days while retaining max points guardrails (DW-83). Build: `cargo build --manifest-path apps/core-server-rs/Cargo.toml` (pass), `cd apps/dashboard-web && npm run build` (pass). Tests pending due to the clean-state gate on this host.
2026-01-08: Follow-up polish: fixed Map tab “blank basemap” when zoom exceeds tile max zoom (MapLibre overscale via per-layer `max_zoom`), simplified Emporia to a single “Address group” control, and compacted Forecast.Solar quota display into Provider status. Refreshed the installed controller to `0.1.9.30`.
2026-01-08: Setup Center nesting polish: moved Emporia meter preferences into a dedicated “Emporia meters & totals” card under Integrations (not nested under token login), and shifted Forecast.Solar public-plan rate-limit guidance into the Provider-status quota tooltip to keep the UI minimal. Refreshed the installed controller to `0.1.9.33`.
2026-01-08: IA cleanup: added a dedicated Overview tab and moved cross-cutting “System overview” + schedules snapshot there; removed legacy catch-all adoption UI from Setup Center and duplicate discovery scan from the Connection tab; added explicit Backups entry points from Nodes. Refreshed the installed controller to `0.1.9.35`.
2026-01-08: Sidebar nav polish: removed the confusing Analytics “live” badge and stopped background polling of analytics outside the Analytics page. Build: `cd apps/dashboard-web && npm run build` (pass).
2026-01-08: Analytics “Feed health” now includes forecast providers by aggregating `analytics_integration_status` across categories in `/api/analytics/feeds/status` (shows Open-Meteo + Forecast.Solar alongside Emporia). Refreshed the installed controller to `0.1.9.36`.
2026-01-09: Hardened Trends relationship analysis (reuse series value maps + safer regression extents) and added Vitest coverage for correlation helpers. Build: `cd apps/dashboard-web && npm run build` (pass). Tests blocked by clean-state gate on this host.
2026-01-09: Added Backups tab controller settings bundle export/restore + database export (raw/sql/csv/json) with OpenAPI updates. Builds: Rust + Next (pass). Tests blocked by clean-state gate on this host.
2026-01-09: Fixed mobile header interactions (hamburger + account dropdown) by making sidebar + dropdown React-managed (no Preline JS dependency) and added Playwright mobile audit coverage (iPhone 13 WebKit + Chromium) with screenshots under `manual_screenshots_web/mobile_audit_20260109_1112/`.
2026-01-09: Fixed Sensors page crash when selecting a sensor (hooks ordering in `SensorDetailDrawer`) and added a Playwright regression check for opening/closing the drawer in mobile browsers.
2026-01-10: Map tab placement UX polish: “Place devices” now stacks Sensors under Nodes, and sensors default to inheriting their parent node map location unless overridden. Refreshed installed controller to `0.1.9.49`.
2026-01-10: Weather forecast chart UX: temperature plot now includes humidity (%), precipitation moved into the cloud cover chart, and precipitation axes clamp to 0 (no negative precipitation). Refreshed installed controller to `0.1.9.50`.
2026-01-10: Analytics weather “Next 7 days” temperature min/max chart now uses floating range bars (min→max) for easier day-to-day scanning.
2026-01-10: Fixed remaining Sensors detail crash triggered by TrendChart hook ordering (empty → loaded series); refreshed installed controller to `0.1.9.51`.
2026-01-10: Trends charts now render visible gaps across missing telemetry windows (node/sensor offline) by inserting `null` breakpoints between distant timestamps; refreshed installed controller to `0.1.9.67`.
2026-01-10: Power tab Renogy charting + units UX: split Renogy telemetry into separate power (W), voltage (V), and current (A) charts (no mixed units), derive battery power (W) from V×A, and standardize technical “power” labels with units across the dashboard.
2026-01-10: Analytics battery UX: the Fleet status “Battery” card now shows live battery voltage/current as the primary value and labels Renogy SOC explicitly to reduce confusion when SOC stays pinned (for example, 100% for long periods). Refreshed installed controller to `0.1.9.66`.
2026-01-10: Forecast.Solar PV config UX: saving PV settings now triggers an immediate forecast poll so Analytics PV overlays refresh without waiting for the next scheduled run.
2026-01-10: Node sensor configuration is now dashboard-driven: the node detail drawer includes a “Node sensor config” editor that applies/pushes the node-agent sensor list via `/api/nodes/{id}/sensors/config` (DW-100); refreshed installed controller to `0.1.9.61`.
2026-01-10: Tier A smoke on the installed controller bundle `0.1.9.69` closed Map/Trends/Backups/Analytics follow-up tickets (clean-host E2E deferred to cluster tickets). Evidence: `project_management/runs/RUN-20260110-tier-a-smoke-0.1.9.69.md`.
DW-52 is complete: the Deployment UI now includes host key verification UX, secret redaction, prerequisites guidance, and surfaces idempotent outcomes.
DW-51 is complete: the Nodes onboarding surface now includes a WS-2902 one-click setup wizard that creates a tokenized ingest URL, shows a LAN-reachable host hint for on-network devices, includes a no-hardware “Send sample upload” validation action, and trends the default weather sensors at ~30s cadence (now includes humidity, wind gust, and rain rate; see `docs/runbooks/ws-2902-weather-station-setup.md`). Refreshed installed controller to `0.1.9.53`.
2026-01-05: Completed the dashboard-web UI migration to Preline admin/settings templates for consistent layout + production polish (including `/sim-lab`); validated via `make ci-web-smoke` + `make e2e-web-smoke` (DW-65).
2026-01-06: Shipped controller bundle `0.1.9.13` adding a node-centric Power tab and node-first Sensors/Trends grouping so Emporia + Renogy readbacks are organized per node with explicit units (tests still pending on the production host due to the clean-state gate).

---

2026-01-19: Started DW-159 to refactor the Sensors & Outputs “Add sensor” drawer into a cohesive, task-first flow (remove UI drift, enforce `NodeButton` variants, and fix inconsistent nesting/hierarchy).
2026-01-19: Started DW-160 to standardize collapsible section containers across dashboard tabs via a single shared `CollapsibleCard` pattern (reduce drift; improve information density).
2026-01-19: Started DW-161 to redesign Overview’s “Configure local sensors” modal with node hierarchy, drag-and-drop ordering, and mobile-friendly bulk actions.
2026-01-19: Started DW-162 to add per-container Analytics time-range controls (24h/72h/7d) including PV forecast history overlays and Weather forecast segmented views.
2026-01-20: Completed DW-165 to reorganize Analytics IA (dedicated Analytics sidebar group; Analytics Overview/Trends/Power routes and shared header pattern), keep legacy `/trends` + `/power` entrypoints functional, and standardize controller-local time for Analytics Overview/Trends/Power. Tier A: installed controller refreshed to `0.1.9.176` (run: `project_management/runs/RUN-20260120-tier-a-dw165-analytics-ia-0.1.9.176.md`).
2026-01-20: Started DW-167 to remove Analytics subpage tabs from the header (use sidebar navigation) and do minor Analytics Overview copy cleanup (“Solar / UV”).
2026-01-20: Started DW-168 to fix the Analytics Overview weather-history chart layout so Solar/UV and Pressure render as full-size cards with readable axes (no stacked mini-charts), plus compact 24h x-axis ticks and full-width Forecasts layout.
2026-01-20: Started DW-169 to fix the Display order (“Reorder…”) modal overflowing the viewport on Nodes and Sensors & Outputs.
2026-01-20: Started DW-170 to move Battery voltage to a full-width row on Analytics Overview (avoid squeezed layout next to Fleet status).
2026-01-20: Completed DW-170 to move Battery voltage to a full-width row on Analytics Overview; Tier A validated on installed controller `0.1.9.180` (run: `project_management/runs/RUN-20260120-tier-a-dw170-analytics-battery-full-width-0.1.9.180.md`).
2026-01-20: Started DW-171 to tighten the Analytics Overview Weather forecast panel layout so it never shows a blank “half column” when only one chart is available.
2026-01-20: Completed DW-171 Weather forecast layout tighten; Tier A validated on installed controller `0.1.9.181` (run: `project_management/runs/RUN-20260120-tier-a-dw171-analytics-weather-forecast-layout-tighten-0.1.9.181.md`).
2026-01-20: Started DW-172 to fix Weather station “Live readings” layout crowding/overlap issues on Analytics Overview.
2026-01-20: Completed DW-172 Weather station “Live readings” layout fixes; Tier A validated on installed controller `0.1.9.182` (run: `project_management/runs/RUN-20260120-tier-a-dw172-weather-station-live-readings-layout-0.1.9.182.md`).
2026-01-20: Completed DW-173 Analytics Overview UI/layout/rendering audit (water ticks + forecast/PV chart rendering fixes). Tier A validated on installed controller `0.1.9.184` (run: `project_management/runs/RUN-20260120-tier-a-dw173-dw174-0.1.9.184.md`).
2026-01-20: Completed DW-174 Display order modal viewport-safe scrolling fixes (Nodes + Sensors & Outputs). Tier A validated on installed controller `0.1.9.184` (run: `project_management/runs/RUN-20260120-tier-a-dw173-dw174-0.1.9.184.md`).
2026-01-20: Started DW-175 to unify Analytics Overview range selector UI (Weather forecast selector matches other range controls).
2026-01-18: Completed DW-151 to fix a regression where the per-node “Hide live weather (Open‑Meteo)” toggle still showed Open‑Meteo sensors in Nodes/Sensors/Map listings. Tier A: installed controller refreshed to `0.1.9.164` (run: `project_management/runs/RUN-20260118-tier-a-dw151-hide-live-weather-ui-filter-0.1.9.164.md`). CI: `make ci-web-smoke` (pass).
2026-01-18: Implemented DW-152 (unify “Public provider data” labeling + consistent sensor origin badges across dashboard surfaces), DW-153 (Trends “Related sensors” acknowledge/deprioritize + default all-nodes scope), and DW-154 (centralize hide behavior via API-enforced sensor visibility; remove per-page filters; ensure hidden sensors cannot persist in Trends charts). Validation: `make ci-web-smoke` (pass), `cd apps/dashboard-web && npm run build` (pass). Updated Tier A Playwright toggle coverage to align with the new API-visible-by-default behavior. 2026-01-19: Tier A validated on installed controller `0.1.9.165` (run: `project_management/runs/RUN-20260119-tier-a-cs88-dw152-dw153-dw154-dw155-0.1.9.165.md`).
2026-01-18: Implemented DW-155 to polish the Trends tab UI for cohesion (aligned card shadows/typography, added “Chart settings” header, and normalized Matrix Profile padding). Validation: `make ci-web-smoke` (pass), `cd apps/dashboard-web && npm run build` (pass). 2026-01-19: Tier A validated on installed controller `0.1.9.165` (run: `project_management/runs/RUN-20260119-tier-a-cs88-dw152-dw153-dw154-dw155-0.1.9.165.md`).
2026-01-19: Completed DW-156 to add a Trends “Events (spikes)” related-sensors mode (event co-occurrence + lead/lag + optional conditioning bins), per-panel analysis keys, and opt-in “deep” computations (full lag sweep + heatmap resolution). Tier A validated on installed controller `0.1.9.166` (run: `project_management/runs/RUN-20260119-tier-a-dw156-trends-events-analysis-keys-0.1.9.166.md`). CI: `make ci-web-smoke` (pass); build: `cd apps/dashboard-web && npm run build` (pass).
2026-01-19: Completed initial pass of DW-158 to attach per-visualization “Key” panels across Trends and define all variables shown in the UI (e.g., correlation `r`, buckets `n`, lag, event threshold `z`, matrix-profile distance). Tier A validated on installed controller `0.1.9.170` (run: `project_management/runs/RUN-20260119-tier-a-dw158-trends-analysis-keys-0.1.9.170.md`). CI: `make ci-web-smoke` (pass); build: `cd apps/dashboard-web && npm run build` (pass).
2026-01-19: Reopened DW-158 after additional UX feedback: ensure Keys exist adjacent to each sub-tool/visualization (no scrolling required) and rewrite copy for non-technical operators.
2026-01-19: Continuing DW-159/DW-160/DW-161/DW-162 after follow-up UX feedback (ensure drawer cohesion, expand collapsible coverage, and capture Tier A evidence for the new controls).
2026-01-19: Completed DW-158 follow-up: clarified “Buckets (n)” to “Overlap (n)” across Trends analysis surfaces and keys; Tier A validated on installed controller `0.1.9.174` (run: `project_management/runs/RUN-20260119-tier-a-dw158-overlap-n-0.1.9.174.md`).

2026-01-19: Completed DW-163 to stack Outputs below Sensors in the per-node Sensors & Outputs panels (prevents the Sensors table from overflowing on desktop). Validation: `make ci-web-smoke` (pass); build: `cd apps/dashboard-web && npm run build` (pass).

## 6. Schedules and Alarms

**Status:** Done (Tier A validated on installed controller `0.1.9.265-alarms-incidents`; Tier B clean-host E2E deferred to DT-59)

**Description:** This epic covers the development of the scheduling and alarm system for the platform. This includes creating and managing schedules for automated tasks, and defining and triggering alarms based on sensor data.

**Goals:**
- Provide a flexible and powerful scheduling system.
- Implement a reliable and responsive alarm system.

**Recent Progress:** 2026-02-11: Completed SA-17 Tier A validation on installed controller `0.1.9.265-alarms-incidents` including installed health smoke, end-to-end operator flows (incidents assign/snooze/close/notes), related-signals investigation, rule guidance visualization (stats/bands/histogram), and historical backtest; passed the Tier‑A screenshot hard gate (run: `project_management/runs/RUN-20260211-tier-a-sa17-alarms-incidents-0.1.9.265-alarms-incidents.md`). 2026-02-11: Completed SA-13..SA-16 to upgrade Alarms into an incident-first operator workflow (assign/snooze/close/notes), add rule guidance visuals (stats/bands/histogram) and a first-class historical backtest, and enhance alarm investigation with controller-wide related-signal analysis and action-log context while keeping `/alarms2` unchanged. Local validation passed (`make ci-core-smoke`, `make ci-web-smoke`). 2026-02-10: Implemented a new rule-based conditional alarm system in Rust core-server (`SA-10`) with typed/composable rule conditions, preview + CRUD APIs, transition-aware alarm event payloads, and a fast-path sensor ingest trigger for evaluations. Implemented a dedicated dashboard `/alarms` surface (`SA-11`) with rule library, active alarms, history, health, and a guided creation wizard that scales from basic thresholds to complex conditions. Local validation passed (`cargo build`, `cargo test`, `cd apps/dashboard-web && npm run build`, `make ci-web-smoke`). Tier A validation (`SA-12`) completed on installed controller `0.1.9.263`, including installed health smoke, `farmctl health`, end-to-end trigger/resolve scenarios (threshold, rolling-window, consecutive-period), preview checks, and viewed UI screenshots (run: `project_management/runs/RUN-20260210-tier-a-sa10-sa11-alarms-0.1.9.263.md`).

---

## 7. Backups and Restore

**Status:** Done (Tier A validated on installed controller; Tier B clean-host E2E deferred to DW-99)

**Description:** This epic covers the development of the backup and restore system for the platform. This includes creating backups of the system configuration and data, and restoring the system from a backup.

**Goals:**
- Provide a reliable and easy-to-use backup and restore system.
- Ensure the integrity and security of the backups.

---

## 8. Analytics

**Status:** Blocked: hardware validation (AN-19 Renogy Rover Modbus + AN-29 Forecast.Solar overlay on real Renogy node); Tier A validated on installed controller; Tier B clean-host E2E deferred to CS-69

**Description:** This epic covers the development of the analytics features for the platform. This includes collecting and processing sensor data, and providing insights and visualizations to the user.

**Goals:**
- Provide valuable insights into the operation of the farm.
- Implement a variety of analytics features, such as trend analysis, anomaly detection, and predictive modeling.
- Support predictive anomaly alarms via an external inference API (see `docs/ADRs/0001-external-ai-for-anomaly-detection.md`).
- Treat external feed ingestion (forecast, utility rates, power integrations) as first-class dependencies with explicit provider/credential planning.
- Treat each power integration device/controller as its own node for clarity (Renogy controllers, Emporia meters); avoid implied coupling and make any “fleet totals” explicitly labeled as sums.
- Provide hyperlocal hourly + weekly weather forecasts (internet provider) and per-node PV forecasts (Forecast.Solar Public) with clear units and bounded API payloads while keeping raw history indefinitely.
- Use local ESPHome MQTT as the primary Emporia power source; keep the cloud API available as a fallback.
- Track predictive alarms delivery as `AN-12`–`AN-14` (with scaffolding/briefs in `AN-15`).
- Keep seeded demo database behavior aligned with real-mode predictive alarms (dashboard state uses DB alarms/events; bootstrap/status controls) (`AN-16`).

**Recent Progress:** 2026-01-05: Verified Renogy BT-2 telemetry → controller analytics in production mode: `/api/analytics/status` and the dashboard snapshot (`/api/dashboard/state`) are sourced from live telemetry in the DB so the dashboard can render real SOC/power (see `reports/prod-pi5-renogy-deploy-20260104_051738.log`). 2026-01-05: Shipped controller bundle `0.1.8.7` which adds derived “Storage” power/energy series (`battery_voltage_v` × `battery_current_a`) to `/api/analytics/power` and displays live storage kW in the Analytics UI; AN-23 battery voltage chart is now backed by real `/api/metrics/query` history (see `reports/prod-audit-followup-20260105_0606.md`). 2026-01-06: Emporia cloud ingest now uses the Rust analytics feed service and Setup Center login (`/api/setup/emporia/login`) to derive/store Cognito tokens, persists readings into `analytics_power_samples`, and surfaces feed status/history via `/api/analytics/feeds/status`. 2026-01-06: Shipped prod bundle `0.1.9.8` enabling analytics feed polling by default (no `CORE_ENABLE_ANALYTICS_FEEDS` env required) so Feed health shows enabled and Emporia readings stay fresh. 2026-01-06: Shipped prod bundle `0.1.9.11` adding Forecast.Solar (Public) per-node PV forecasts + Open-Meteo hyperlocal hourly/weekly forecasts, persisted into Timescale (`forecast_points`) and surfaced in Analytics (see `reports/prod-forecast-validate-20260106_032403.log` and screenshots under `manual_screenshots_web/prod_forecast_post_0.1.9.11_20260106_041239/`). 2026-01-06: Shipped prod bundle `0.1.9.12` improving `/api/analytics/power` bucketing (24h 5-minute + 168h hourly) so power charts update throughout the hour and no longer look “daily-only” on 168h views. 2026-01-06: Shipped prod bundle `0.1.9.13` adding Emporia virtual nodes + per-device/per-circuit sensors/metrics (persisted indefinitely) and a node-centric Power surface with per-node breakdowns (no implied coupling between integrations). 2026-01-08: Added per-meter Emporia preferences (enabled/include/group label) and updated `/api/analytics/power` to compose Emporia mains + Renogy load/PV/battery while respecting per-meter inclusion; shipped in controller bundle `0.1.9.29` (tests pending due to the clean-state gate on this host). 2026-01-07: Added Setup Center Forecast.Solar PV configuration (Public) with configurable parameters, check-plane validation, and Public rate-limit guidance; builds validated, tests pending due to the clean-state gate on this host. 2026-01-08: Updated Setup Center + Analytics PV sections to render per-node cards for each solar charge controller node (instead of a single dropdown) and added a “Use map placement” helper for coordinates; refreshed the installed controller to `0.1.9.31` (tests pending due to the clean-state gate on this host). 2026-01-08: Expanded Emporia cloud ingest to persist voltage/current readbacks (including nested-device channels) and surfaced them in the Power UI; improved poll completeness with retries for null channel usage values and canonicalized channel keys so readbacks align across units; refreshed the installed controller to `0.1.9.39` (tests pending due to the clean-state gate on this host). 2026-01-10: Derived Emporia per-channel watts from V×A when the kWh usage response omits usage for a channel, tagging derived sensors with `derived_from_va` and surfacing a subtle “calc” marker in the circuits table so partial readbacks render cleanly. 2026-01-10: Analytics Weather forecast now includes a “Next 24 hours” quick-view above the existing 72-hour and 7-day charts; refreshed the installed controller to `0.1.9.65`. 2026-01-12: Introduced a stable Core node and surfaced weather + PV forecast as long-retention sensors (stored in `forecast_points`, visible in Nodes/Sensors/Trends via `/api/sensors` + `/api/metrics/query`); validated on installed controller `0.1.9.90` (Tier A screenshots under `manual_screenshots_web/tier_a_core_node_0.1.9.90/`).

---

2026-01-31: Fixed `GET /api/analytics/soil` to aggregate soil moisture from real `metrics` data (avg/min/max + field summaries) so Analytics Overview matches Trends; Tier A validated on installed controller `0.1.9.232` (run: `project_management/runs/RUN-20260131-tier-a-an35-soil-analytics-0.1.9.232.md`).

## 9. iOS App

**Status:** Deferred indefinitely (moved off `main`; preserved on `freeze/ios-watch-2026q1`)

**Description:** Native iOS/watch development is currently paused on `main`. The latest mobile code is preserved on branch `freeze/ios-watch-2026q1` for future reactivation without polluting current `main` production scope.

**Goals:**
- Preserve mobile source history in a dedicated branch so work can resume cleanly later.
- Keep `main` production scope accurate by preventing deferred mobile paths from presenting as active features.
- Track any future reactivation via explicit tickets moved back from `TASKS_DEFERRED_INDEFINITE.md`.

**Recent Progress:** 2026-01-06: Completed production wiring for iOS/watch: login-first UX backed by `/api/auth/login` + Keychain token persistence (clears on 401); removed demo injection and localhost defaults so mobile targets an installed controller via discovery/manual entry; watch receives base URL + token from the phone via WCSession; split `AppEntry.swift` into focused `Models/`, `Services/`, and `Views/` modules. 2026-02-06: Moved mobile implementation/validation tickets (IOS-30/IOS-31) to `project_management/TASKS_DEFERRED_INDEFINITE.md`, preserved sources on `freeze/ios-watch-2026q1`, and removed iOS/watch surfaces from `main`.

---

## 10. Documentation

**Status:** Done

**Description:** This epic covers the development of the project documentation. This includes creating and maintaining documentation for users, developers, and administrators.

**Goals:**
- Provide clear and comprehensive documentation for the project.
- Ensure that the documentation is up-to-date and easy to understand.
- Capture local-only testing/CI workflow expectations (installer-first E2E plus `make ci` for full suites; avoid external runners).
- Document the repeatable “multiple fresh installs on one Mac” approach for installer E2E (isolated temp roots + random ports + namespaced launchd labels + clean uninstall/reset).
- Prevent accidental regressions from Git “cleanup” by documenting safe staging/discard rules and keeping runtime state out of version control.
- Simulator usage is optional; no post-commit boot requirement in `AGENTS.md`.
- Publish a centralized hub that links all component docs and readiness guides.
- Ship a production deployment guide covering infra, TLS, feeds, and observability.
- Provide ad-hoc internal tooling support (e.g., curated Codex skills listings).

**Recent Progress:** 2026-01-16: Removed stale docs (analytics/QA sweeps) and refreshed current runbooks/docs to remove dead `/provisioning` and Python-era feed references. DOC-9 finalized the E2E-required testing guidance and native prerequisites. DOC-10 shipped a start-from-closed Sim Lab usage runbook. DOC-11 recorded the fixed Renogy Rover (`RNG-CTRL-RVR20-US`) + `BT-2` + Raspberry Pi 5 node assumptions in `docs/analytics_feeds.md`. DOC-12 added the Renogy Pi 5 deployment runbook in `docs/runbooks/renogy-pi5-deployment.md`. DOC-13 added the Pi 5 simulator runbook in `docs/runbooks/pi5-simulator.md`. DOC-14 documented the Raspberry Pi 5 deployment tool workflow in `docs/runbooks/pi5-deployment-tool.md`. DOC-15 linked the Renogy Pi 5 runbook from `README.md`. DOC-16 documented the Renogy simulator validation workflow for bundle + ingest verification. DOC-17 confirmed simulator/deployment tooling and runbooks remain tracked (not gitignored). DOC-18 clarified the Renogy Pi 5 deployment steps and split simulator validation into a dedicated runbook. DOC-19 simplified the Renogy Pi 5 deployment for macOS (Imager-only, Ethernet-first, placeholders and broker matching clarified, troubleshooting consolidated). DOC-20 documented first-boot bundle staging + automatic `renogy-bt` install so deployments stay Mac-only with no Pi login. DOC-21 added a repo-wide Mermaid architecture diagram to the root README for quick onboarding/reference. DOC-22 added a user guide for Emporia cloud API setup. DOC-23 added a helper script for Emporia deviceGid discovery. DOC-24 added a production-only, from-scratch core server setup runbook with explicit dependency installation steps. DOC-25 through DOC-27 delivered a non-expert usability pass on the production setup runbook (preflight checklist, copy/paste templates, verification, and troubleshooting). DOC-28 rewrote the production setup runbook for the DMG/launchd architecture and updated cross-references away from legacy container-stack steps; DOC-29 documents repeatable installer E2E runs on a single dev Mac. DOC-34 removed obsolete external delegation workflow instructions. 2026-01-24: DOC-37 captured the Tier-A controller rebuild/refresh runbook audit summary (steps + evidence checklist). 2026-02-03: DOC-38 tightened Tier‑A clean-worktree discipline (runbook + AGENTS) so build gates are satisfied via inventory/classification (commit real work; move artifacts) instead of blind discard. 2026-02-06: DOC-39 added concise execution stop-gate rules in `AGENTS.md` (no silent early stop; explicit de-scope handshake; end-of-turn completion checks).

---

## 12. Telemetry Ingest Sidecar

**Status:** In Progress (TS-9 node-health split + core parity; Tier A pending)

**Description:** This epic moves MQTT telemetry ingestion into the Rust sidecar and keeps predictive alarms running as a separate Python worker that reads from the DB (or an optional light feed from the sidecar).

**Goals:**
- Make the Rust sidecar the only MQTT consumer; core-server MQTT ingest is disabled by default.
- Keep predictive alarms running independently from ingest (DB-driven or sidecar feed) without double ingest.
- Align ingest semantics with the existing core-server pipeline (COV, rolling averages, offline tracking).
- Provide runbooks + native wiring and regression tests for the sidecar-only pipeline.

**Recent Progress:** TS-7 offline flapping fix shipped and validated on the installed controller (Tier A). Evidence: `project_management/runs/RUN-20260110-tier-a-offline-flapping-0.1.9.70.md`. 2026-01-10: Tier A validated TS-8 status-topic mapping and node health fields on installed controller `0.1.9.70` (`nodes.config.agent_node_id` present for Pi5 nodes; `/api/dashboard/state` shows non-zero uptime/CPU/storage after status publishes). Evidence: `project_management/runs/RUN-20260110-tier-a-phase3-adoption-ts8.md`. 2026-02-08: TS-9 implementation completed locally: sidecar now stores explicit ping + MQTT RTT fields, node-agent publishes ICMP ping p50/jitter, core controller emits matching health status, and dashboard Nodes/Detail surfaces ping+jitter+30m+uptime24h+storage+RAM. 2026-02-09: Updated TS-9 so node-health (“system”) sensors are **visible (not hidden)** and selectable on Trends. Tier A installed-controller validation remains pending.

---

## 13. Standalone Rust Telemetry + Predictive

**Status:** To Do (deferred/optional; not required for production while predictive is disabled by default)

**Description:** This epic replaces the sidecar + Python predictive worker with a single Rust service that handles both ingest and predictive alarms end to end.

**Goals:**
- Deliver a Rust service that ingests MQTT telemetry, writes metrics, and evaluates predictive alarms.
- Include the Rust LLM client, sandbox/tooling integration, retries, and backpressure handling.
- Ship dedicated integration/load tests and validated rollback paths back to sidecar + Python.

---

## 14. Setup App & Native Services

**Status:** In Progress (SETUP-33/SETUP-34/SETUP-38 setup UX + admin config)

**Description:** This epic delivers a dedicated local setup app with a GUI wizard and a native (launchd-based) production stack for macOS.

**North-Star Outcome:**
- A non-expert can take a brand-new Mac mini, run a single installer, answer a few prompts, and end up with a running system plus a health UI and guided node onboarding.
- No manual edits, no copy/paste commands, and upgrades/backups are one-click (or one command).

**North-Star Acceptance Gate (Setup):**
- Single installer DMG auto-launches the wizard (no Terminal steps).
- Installer launcher is native (Swift or `.pkg` bootstrap); no AppleScript in the production installer path.
- Minimal prompts; bundle/farmctl auto-detect; advanced fields hidden by default.
- Dashboard lands on `/login` and requires sign-in per browser session; fresh installs create a bootstrap admin user (temp password shown in the installer output).
- Wizard flow is `Welcome → Configure → Preflight → Plan → Operations`; preflight reserves `warn` for actionable issues (expected states like “existing install present” are `info`).
- Launch plan generation shows no warnings on a clean machine (missing binaries are expected before first install).
- MQTT host is configured for real LAN nodes (not hidden behind “advanced”); the wizard can auto-populate the controller’s LAN IP for `mqtt_host`.
- Services start at boot with no user logged in (LaunchDaemons/system launchd domain).
- Services run as a least-privilege service user (not root); only install/bootstrap requires admin.
- DB + MQTT + Redis are bundled/provisioned without manual dependency steps.
- Controller bundles are local-path DMGs (no remote bundle downloads).
- Controller bundle DMG is embedded inside the installer app bundle (`Contents/Resources/...`), not visible on the mounted DMG root.
- Setup Center health/install/upgrade/backup works without manually starting a setup service.
- `make e2e-installer-stack-smoke` validates DMG install/upgrade/rollback/uninstall in a clean temp root.
- `make e2e-installer-stack-smoke-quarantine` validates the same flow with a simulated quarantined-downloaded installer DMG (no manual `xattr`).
- Installer/E2E includes a clean uninstall/reset so repeated installs are safe.
- E2E runs start and end from a verified clean state (no orphaned launchd jobs or background processes before/after).
- E2E runs must not introduce new persistent launchd enable/disable override keys for their E2E labels; historical `com.farmdashboard.e2e.*` override residue can be purged one-time with `tools/purge_launchd_overrides.py` (admin required).
- Downloaded/quarantined installer artifacts remain installable without manual `xattr`; bundle mounting is quarantine-safe.

**Elegant Solution Architecture (3 layers):**
1) **Distribution and Versioning (Productized Delivery)**
   - Ship a versioned controller bundle (images plus configs) so install does not require building from source.
   - Provide a single entrypoint tool (`farmctl`) that knows the release manifest and can install/upgrade/rollback.
   - Goal: "Install vX.Y.Z" becomes a deterministic, one-step action.
2) **Install and Configure (Guided and Idempotent)**
   - A setup assistant (CLI or small local web wizard) that checks prerequisites, asks for minimal inputs, writes config, generates secrets, starts services, and verifies health with clear green checks.
   - Everything is idempotent (re-running is safe).
3) **Operations and Onboarding (UI-First)**
   - A System Setup area in the dashboard for infra status, backups, updates, and guided node adoption.
   - Central place for credentials (Emporia tokens, etc.) and a one-click diagnostics export for support.

**Implementation Phases (Elegant, Not Band-Aid):**
- Phase 1: Productized release plus install tool (build/publish bundles, `farmctl install` uses release images/configs, no source build required).
- Phase 2: Guided setup assistant (interactive prompts to config/start/verify with optional local web UI).
- Phase 3: Operations and onboarding UI (Setup Center in dashboard for health, updates, backups, and node adoption).

**Goals:**
- Provide a separate local setup app with a GUI wizard for non-expert operators.
- Generate and manage launchd services for core-server, telemetry-sidecar, dashboard-web, and the Rust setup daemon.
- Production uses LaunchDaemons (system). E2E uses LaunchAgents (`gui/$UID`) with isolated temp roots/ports/labels.
- Package and distribute native binaries/bundles for production installs.
- Provide guided install/upgrade/rollback flows with health verification.
- Provide a first-class uninstall/reset so repeated E2E installs are safe on a single dev Mac.
- Provide diagnostics export for support without exposing secrets by default.
- Prefer Rust for new setup tooling and refactor installer logic into Rust where feasible.


---

## 15. Architecture & Technical Debt

**Status:** In Progress (ARCH-5 pulse fail-closed follow-up; ARCH-6B Tier B validation deferred)

**Description:** Surface and reduce cross-stack technical debt: mixed-scope “god files”, dead/fallback branches, and stubs that can be confused for real production features.

**Goals:**
- Log every over-1k-line production file (after excluding generated bundles) and summarize overlapping responsibilities so maintainers can triage split order.
- Execute phased refactors that split mixed-scope files into focused modules without behavior regressions.
- Remove deceptive stubs/fallbacks from active production paths or make them explicit fail-closed behavior.
- Keep tracker/board/epic status aligned so deferred vs real features are unambiguous on `main`.

**Recent Progress:** 2026-01-22: Completed ARCH-1 by cataloguing the god-file candidates, describing their responsibilities, and surfacing the work on the board and task tracker for future cleanup. 2026-02-06: Completed ARCH-2/ARCH-3/ARCH-4 cleanup pass on `main`: removed `farmctl` stub bundle mode (`--stub` and fake artifact/native-deps writers), removed `/api/dashboard/demo` and dashboard snapshot reconstruction fallback (`/api/dashboard/state` now fail-closed), extracted node-overlay packaging out of `apps/farmctl/src/bundle.rs` into `apps/farmctl/src/bundle_node_overlay.rs`, added the production token guardrail (`tools/production_token_guardrail.py` + `tools/guardrails/production_token_allowlist.json`) with CI wiring, and validated with `make ci-integrity-guardrail`, `make ci-core-smoke`, `make ci-farmctl-smoke`, `make ci-web-smoke-build`, `make e2e-installed-health-smoke`, and `python3 tools/api-sdk/generate.py` (run log: `project_management/runs/RUN-20260206-installed-controller-smoke-main-integrity-cleanup.md`). 2026-02-12: Completed ARCH-6 pruning pass (removed non-shipping surfaces, deleted dead legacy code, reduced Python footprint, curated old run artifacts). Tier A validated installed controller `0.1.9.268-arch6-prune` with screenshot hard gate (run log: `project_management/runs/RUN-20260212-tier-a-arch6-prune-0.1.9.268-arch6-prune.md`). Tier B validation is deferred indefinitely per user instruction (tracked as ARCH-6B). Remaining follow-up is tracked as ARCH-5 (node-agent GPIO pulse counter stub-mode fail-closed in production). 2026-02-16: Completed ARCH-7 to shrink generated SDK artifacts by removing unused generated docs/tests and enforcing generator guardrails (`python3 tools/api-sdk/generate.py`, `make ci-node-smoke`, `make ci-web-smoke-build`).


---

## 16. Time-Series Similarity Engine (TSSE)

**Status:** Done (TSSE-37 Tier‑A validated on installed `0.1.9.255-related-diurnal-penalty`; Tier B DT-59)

**Description:** Build a first-class, server-side time-series similarity search engine that supports high-resolution analysis over long ranges without user-facing failures. Replace client-side “scan” loops (many `/api/metrics/query` calls + in-browser scoring) with durable analysis jobs that stream progress, return explainable ranked results, and generalize across similar analyses (Related Sensors, Relationships, Events/Spikes matching, Co-occurrence, Matrix Profile-like workflows).

**Non-Negotiables (User-Facing):**
- The user can search for correlations/similarity at high time resolution over long time ranges.
- The user can run any scan without “requested series too large” errors; the user is never required to decrease interval.
- Episodic relationships must rank highly even when separated by long periods of weak/no relationship.
- Outliers must not dominate ranking.
- The selected range acts as a maximum horizon; the engine searches smaller windows automatically (within a bounded “reasonable limit”).

**Committed Architecture (Unambiguous; No Analysis Fallback):**
- Postgres/Timescale remains authoritative storage (unbounded retention) + metadata store for jobs/results.
- A Rust replication pipeline maintains a read-optimized, partitioned Parquet “analysis lake” for the hot analysis horizon (90d) on the controller.
- Similarity and related analyses run as server-side analysis jobs that:
  1) use Qdrant (required) for fast candidate generation via multi-scale embeddings/features
  2) use embedded DuckDB for exact episodic scoring over Parquet (full resolution; no forced downsampling of user requests)

**Single-Agent Requirement (Hard):**
- Every pending/incomplete TSSE implementation ticket must be executed by a single agent; the Collab Harness multi-agent workflow is no longer required for remaining TSSE work.

**Goals:**
- Ship an analysis job framework (create/progress/cancel/result) inside `apps/core-server-rs`.
- Eliminate “Requested series too large” failure mode by design (job-based results + preview/drilldown endpoints + streaming/paging where needed).
- Implement robust multi-scale similarity scoring with episodic “episode” outputs that explain *when* and *how* sensors are related.
- Provide macOS-first deployment for new analytics dependencies (Qdrant launchd integration via `farmctl`).
- Add performance benchmarks + observability so regressions are detectable on a single Mac mini.

**Recent Progress:** 2026-01-23: Worker A implemented server-side analysis job schemas + runners for `correlation_matrix_v1`, `event_match_v1`, `cooccurrence_v1`, and `matrix_profile_v1` in `apps/core-server-rs` (bounded params, cancel-aware progress phases, DuckDB-backed results). 2026-01-23: Worker C delivered API/UX design proposals for analysis jobs (job-based Related Sensors flow, progress polling, episode summaries + preview drilldown contract, and large-series paging/streaming UI handling with explicit decimation/watermarks). 2026-01-24: Worker A implemented cursor-based paging for `/api/metrics/query` and dashboard paging merge so charts never fail on “series too large” (unit tests added). 2026-01-24: Worker C refactored Trends Relationships, Cooccurrence, and Matrix Profile panels to job-based analysis UX (submit/poll/cancel/result with status/events display) and updated Playwright job stubs/tests to match the new contract. 2026-01-24: Worker C aligned co-occurrence job request params with the backend (`sensor_ids` required, `focus_sensor_id` optional) and removed legacy client-only fields from the request payload. 2026-01-24: Worker C fixed dashboard `InlineBanner` tone typing (`danger`) so TSSE panels pass TypeScript checks under `next build`. 2026-01-24: Added a Postgres<->Parquet parity spot-check runbook + ops CLI for controller-side verification. 2026-01-24: Worker A updated candidate widening to relax `interval_seconds`/`is_derived`/`is_public_provider`, added payload index schema assertions for those filters, and chunked `tsse_recall_eval` API windows to avoid metrics-query max-window errors. 2026-01-24: Worker D implemented replication bulk export (Postgres COPY → DuckDB → partitioned Parquet) and updated backfill staging. 2026-01-24: Worker C added a profiling hook (flamegraph) for analysis jobs + standardized `timings_ms` keys across TSSE jobs. 2026-01-24: Worker E added an always-visible computed-through watermark + Playwright assertions for AutoComparePanel; Playwright TSSE specs pass under the `chromium-desktop` project. 2026-01-24: Tier‑A validated installed controller to `0.1.9.212` and closed TSSE‑1 by reviewing captured screenshots and fixing the installed Trends 403 (`analysis.run`) regression via an idempotent admin-capabilities backfill migration (run: `project_management/runs/RUN-20260124-tier-a-tsse-0.1.9.212.md`). 2026-01-25: Fixed lag search missing sharp correlation peaks by switching to bucket-aligned lag evaluation with exact sweep when bounded and adding a regression test (TSSE-26). 2026-01-25: Batched Related Sensors candidate reads and scored batches concurrently to avoid sequential DuckDB reads (TSSE-27). 2026-01-25: Added significance filtering (p-value + min overlap) for Related Sensors scoring and correlation matrix outputs (TSSE-28). 2026-01-25: Recompute rolling Pearson sums every 1000 iterations to avoid drift (TSSE-29). 2026-01-25: Added correlation confidence intervals to API responses and surfaced them in Trends UI (TSSE-30). 2026-01-25: Extracted TSSE scoring magic numbers into named constants with rationale (TSSE-31). 2026-01-25: Fixed significance UX + Spearman correctness (p-values/CI) + status-aware correlation matrix labeling (TSSE-32). 2026-01-26: Recorded Phase 0 semantics and centralized correlation inference helpers in a shared Rust module (tracker: `project_management/archive/trackers/TSSE_TSE_STATISTICAL_CORRECTNESS_TRACKER.md`). 2026-01-26: Completed tracker Phase 2 parameter consistency (remove hidden lag overlap + echo effective params). 2026-01-26: Fixed analysis job `job_key` dedupe indexing to avoid `500 Database error` on very large keys; Tier‑A refreshed installed controller to `0.1.9.215` (run: `project_management/runs/RUN-20260126-tier-a-analysis-job-key-hash-0.1.9.215.md`). 2026-01-26: Implemented TSSE/TSE statistical correctness tracker Phase 3/4/5 (autocorr-adjusted `n_eff`, lag-selection correction, BH-FDR `q_value`) and updated Trends UI tooltips to show `p` vs `q` and `n_eff` (TSSE-36). 2026-02-06: Extended TSSE-36 with effect-size gating (`min_abs_r`) and bucket aggregation controls (`bucket_aggregation_mode` with per-sensor `auto` resolution), surfaced non-significant `r` values in correlation matrix cells, refreshed Trends TSSE UI semantics (`p/q/n/n_eff/m_lag`), removed dead TSSE placeholders (`tsse/preview.rs`, `tsse/qdrant_client.rs`), and Tier‑A validated installed controller `0.1.9.250-tsse36-ui-polish` with viewed screenshot evidence (run: `project_management/runs/RUN-20260206-tier-a-tsse36-0.1.9.250-tsse36-ui-polish.md`). Also hardened Tier‑A tooling (`tools/rebuild_refresh_installed_controller.py`, `apps/dashboard-web/scripts/web-screenshots.mjs`), completed a one-time cleanup of accumulated external build artifacts under `/Users/Shared/FarmDashboardBuilds`, removed stale sibling artifact dirs/files under `/Users/Shared`, and reran `cargo test --manifest-path apps/core-server-rs/Cargo.toml` + `make ci-web-smoke` (PASS).

**Recent Progress:** 2026-01-23: Worker B delivered algorithm proposals for episodic similarity scoring (multi-window + robust stats + lag refinement), multi-scale embeddings, Qdrant candidate-generation safeguards, and a curated-pairs recall harness aligned with TSE-0008/0009/0010/0015/0016/0017. 2026-01-23: Worker B added concrete schema sketches (candidates + why-ranked + preview payloads), Rust module layout, and benchmark hook outlines for TSE-0008/0009/0010/0011/0012/0020. 2026-01-23: Worker B proposed bounded compute strategies for correlation matrix, event matching, co-occurrence, and matrix profile (early-stop + caps + parameter defaults). 2026-01-24: Worker B audited analysis job observability surfaces and implemented runner-level tracing spans + durable phase timing events (`phase_timing`, `runner_summary`) in `apps/core-server-rs`; added a consistent `why_ranked` summary for `event_match_v1` candidates and documented the schema in `project_management/tickets/TSE-0020-observability-profiling-why-ranked.md`. 2026-01-24: Worker B drafted a recall@K harness design for ANN candidate generation on the synthetic clustered-sensor bench dataset (TSE-0008/0009). 2026-01-23: Worker D drafted the ops/packaging plan for Qdrant bundling, launchd integration, permissions, and health strategy for TSE-0007. 2026-01-23: Worker D reviewed TSE-0007/0019/0022, confirmed current Qdrant bundling/launchd wiring, and captured missing perms/path hardening plus a Tier‑A TSSE validation checklist. 2026-01-23: Worker D drafted the TSSE bench report template under `reports/` and enumerated remaining security test gaps (job caps, preview max window) plus Tier-A evidence expectations. 2026-01-24: Worker D added TSSE bench tooling (`apps/core-server-rs/src/bin/tsse_bench_dataset_gen.rs` + `apps/core-server-rs/src/bin/tsse_bench.rs`), added security hardening tests for analytics endpoints (cap enforcement, per-user job cap 429, preview max window clamp, path validation), and added a Tier‑A TSSE evidence template under `project_management/runs/`.

**Recent Progress:** 2026-01-23: Worker A reviewed the TSSE data-plane implementation (analysis lake, replication, DuckDB reads, chart paging) and documented acceptance gaps + proposed code changes for TSE-0004/0005/0006/0018/0021.

---

## 17. Offline Telemetry Spool + Backfill Replay

**Status:** Done (Tier A + hardware validated; Tier B OT-13) (Option C: append-only segment spool + Rust node-forwarder + controller ACK; OT-1..OT-15)

**Description:** Ensure Raspberry Pi nodes can tolerate hard disconnects from the controller (hours to days) without losing telemetry or producing false “offline” flaps during backfill. This epic introduces a microSD-friendly, append-only segment spool on each node and a Rust node-forwarder responsible for live publish + rate-limited replay, plus controller-side ACK and liveness semantics that are correct under backfill and MQTT QoS 1 duplicates.

**Goals:**
- Nodes **always sample** on schedule, regardless of controller reachability.
- Buffer at least **48h** of telemetry for baseline workloads with bounded disk usage and deterministic drop policy.
- Replay backlog on reconnect with explicit throttles and without starving live status.
- Correctness under MQTT QoS 1: duplicates are expected; ingest remains idempotent.
- Controller liveness is stable during replay (receipt-time based; monotonic) while still exposing “data freshness” from sample timestamps.
- Provide operator-visible spool health surfaces (bytes/age/drops/acked_seq) and clear evidence when data is dropped.

**Non-goals (Phase 1):**
- High-rate/bursty payload classes like audio/vibration streaming (explicitly out of scope unless promoted to a requirement).
- At-rest encryption / device-capture threat model (Phase 2 if required).
- MQTT v5-only features (MVP remains compatible with MQTT 3.1.1 client semantics).
- Bulk HTTP backfill ingest (Phase 2 if MQTT replay becomes a throughput bottleneck at scale).

**Success Metrics:**
- Baseline sizing: 10 channels @ 1 Hz for 48h fits in ~66 MiB at ~40 B/sample; catch-up in <15 minutes at 2,000 publishes/s (rate-limited).
- No “offline” flaps during backlog replay (controller liveness based on receipt time).
- Crash/power-loss during outage loses at most the configured sync interval (e.g., ~1s) and only corrupts the tail frame, which is truncated on recovery.
- Spool remains bounded: cap enforcement + drop-oldest emits explicit loss-range events.

**Defaults / Assumptions (implemented in Phase 1):**
- Disk budget is configurable; default policy: `min(max(1GiB, 5% of filesystem), 25GiB)` plus a “keep free” floor (default `2GiB`), overrideable via env.
- Time accuracy requirement is ±5s over a 48h outage; if sub-second accuracy is required, add monotonic anchors + RTC/PTP strategy (Phase 2 / OT-15).
- Security posture is LAN-trust for MVP; MQTT auth/TLS hardening and at-rest encryption are Phase 2 if required.

**Deltas vs Current System:**
- **Node changes:** introduce `node-forwarder` (Rust) that owns durability + replay; modify `node-agent` sampling to always sample and forward via local IPC; replace legacy small JSONL offline buffer semantics with segment spool + ACK-driven truncation.
- **Controller changes:** add `iot/{node_id}/ack` publishing (post-DB-commit) and update liveness/freshness semantics (`last_rx_at` vs `last_sample_ts`) so backfill cannot regress “last seen”.
- **Unchanged:** controller broker remains Mosquitto; ingest path remains `telemetry-sidecar → TimescaleDB`; MQTT QoS 1 remains the baseline delivery semantics.

**Recent Progress:** 2026-02-01: Implemented `node-forwarder` append-only segment spool + replay/ACK + loss events, rewired `node-agent` to always-sample and forward locally, added controller-side ACK + receipt-time liveness/freshness semantics, surfaced buffering state in the dashboard Node detail UI, and added a disconnect/reboot harness. Tier A validated installed controller to `0.1.9.234-ot49` and hardware validated on Pi 5 nodes (microSD + NVMe). Evidence: `project_management/runs/RUN-20260201-tier-a-ot49-offline-buffering-0.1.9.234-ot49.md`.

**References:**
- ADR: `docs/ADRs/0009-offline-telemetry-buffering:-append-only-segments-+-seq-ack-+-controller-receipt-time-liveness.md`
- Requirements: `project_management/tickets/TICKET-0049-offline-telemetry-spool-+-backfill-replay-(append-only-segments-+-rust-node-forwarder-+-ack).md`
 - Tier A + hardware run: `project_management/runs/RUN-20260201-tier-a-ot49-offline-buffering-0.1.9.234-ot49.md`
