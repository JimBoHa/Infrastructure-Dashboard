# RUN-20260119 — Tier A — CS-88 + DW-152/153/154/155 (0.1.9.165)

- **Date:** 2026-01-19
- **Tier:** A (installed controller refresh; **no DB/settings reset**)
- **Controller version:** 0.1.9.165
- **Controller bundle DMG:** `/Users/Shared/FarmDashboardBuilds/FarmDashboardController-0.1.9.165.dmg`

## Scope

- **CS-88:** Centralize sensor visibility policy at the API boundary (visible-only by default; admin/debug include-hidden mode with metadata; node-level hide + per-sensor override; Map features filtered consistently).
- **DW-152:** Unify ambiguous “Live weather” / “Weather API” wording into **Public provider data** (badge label short-form `PUBLIC`) and ensure consistent sensor origin badges across dashboard surfaces.
- **DW-153:** Trends “Related sensors”: add acknowledge/deprioritize behavior and support all-nodes comparisons (not just same-node).
- **DW-154:** Centralize hide behavior via the backend visibility policy (no per-page filters; hidden sensors cannot persist in Trends selections).
- **DW-155:** Trends tab UI polish (cohesive layout/spacing/typography).

## Upgrade / refresh (installed controller)

Build bundle DMG (note: Tier‑A bundle builds require a clean git tree):

```bash
cargo run --manifest-path apps/farmctl/Cargo.toml -- \
  bundle \
  --version 0.1.9.165 \
  --output /Users/Shared/FarmDashboardBuilds/FarmDashboardController-0.1.9.165.dmg \
  --native-deps /usr/local/farm-dashboard/native
```

Set setup-daemon bundle path + upgrade:

```bash
curl -fsS -X POST http://127.0.0.1:8800/api/config \
  -H 'Content-Type: application/json' \
  -d '{"bundle_path":"/Users/Shared/FarmDashboardBuilds/FarmDashboardController-0.1.9.165.dmg"}'

curl -fsS -X POST http://127.0.0.1:8800/api/upgrade
curl -fsS http://127.0.0.1:8800/api/status
```

Result: `current_version: 0.1.9.165` (previous `0.1.9.164`).

Notes:
- During upgrade, an `xattr: [Errno 13] Permission denied` warning was logged while attempting to modify the local DMG path, but the upgrade completed successfully.

## Installed stack health smoke

```bash
curl -fsS http://127.0.0.1:8800/healthz
curl -fsS http://127.0.0.1:8000/healthz
make e2e-installed-health-smoke
```

Result: `PASS`.

## Tier‑A Playwright validation (installed controller)

Serial execution is intentional (`--workers=1`) to avoid cross-test interference from stateful visibility toggles.

```bash
cd apps/dashboard-web

FARM_PLAYWRIGHT_AUTH_TOKEN=$(cat /tmp/fd_codex_api_token.txt) \
FARM_PLAYWRIGHT_BASE_URL=http://127.0.0.1:8000 \
FARM_TIER_A_VERSION=0.1.9.165 \
npx playwright test \
  playwright/hide-live-weather-toggle.spec.ts \
  playwright/non-local-sensor-badges.spec.ts \
  playwright/trends-auto-compare-tier-a.spec.ts \
  playwright/trends-chart-height-tier-a.spec.ts \
  playwright/trends-matrix-profile-tier-a.spec.ts \
  --project=chromium-mobile \
  --workers=1
```

Result: `5 passed`.

## Evidence (Tier A)

Screenshots captured + viewed:

- Sensors & Outputs drawer shows unified sensor origin badge (`PUBLIC`) for an Open‑Meteo sensor:
  - `manual_screenshots_web/tier_a_0.1.9.165_non_local_sensor_badges_2026-01-19_001519445Z/01_sensors_drawer_badge.png`
- Node detail shows “Hide public provider data” enabled and Open‑Meteo sensors removed from node sensor list surfaces (visibility policy enforced):
  - `manual_screenshots_web/tier_a_0.1.9.165_hide_live_weather_2026-01-19_001514602Z/02_after_toggle_node_detail.png`
- Trends tab shows cohesive layout + Related Sensors panel (all-nodes scope) + chart settings:
  - `manual_screenshots_web/tier_a_0.1.9.165_trends_auto_compare_2026-01-19_001524157Z/01_trends_auto_compare_panel.png`

