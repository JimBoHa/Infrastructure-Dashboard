# RUN-20260204 Tier A — CS-102 / DW-218 / DW-219 (0.1.9.248-derived-of-derived)

## Context

- **Date:** 2026-02-04
- **Tasks:**
  - **CS-102** — Derived sensors: allow derived inputs (enable temp compensation of derived sensors)
  - **DW-218** — Analytics Temp Compensation: allow compensating derived sensors
  - **DW-219** — Derived sensors: allow derived inputs in Derived Sensor Builder
- **Goal:** Refresh the installed controller (Tier A; no DB/settings reset) and verify derived-of-derived sensors work end-to-end:
  - Temp compensation wizard can target a derived sensor and successfully creates a derived-of-derived compensated sensor.
  - Derived Sensor Builder can use a derived sensor as an input and successfully creates a derived-of-derived sensor.

## Preconditions (installed stack)

- Setup daemon health: `curl -fsS http://127.0.0.1:8800/healthz` → **ok**
- Core server health: `curl -fsS http://127.0.0.1:8000/healthz` → **ok**
- Pre-upgrade installed version: `0.1.9.247-derived-lag-buckets` (from `http://127.0.0.1:8800/api/status`)
- Rollback target (previous bundle):
  - `/Users/Shared/FarmDashboardBuilds/FarmDashboardController-0.1.9.247-derived-lag-buckets.dmg`

## Build (controller bundle DMG)

- **Version:** `0.1.9.248-derived-of-derived`
- **Bundle path:** `/Users/Shared/FarmDashboardBuilds/FarmDashboardController-0.1.9.248-derived-of-derived.dmg`
- **Build log:** `/Users/Shared/FarmDashboardBuilds/logs/bundle-0.1.9.248-derived-of-derived.log`

Command:

```bash
mkdir -p /Users/Shared/FarmDashboardBuilds /Users/Shared/FarmDashboardBuilds/logs

cargo run --manifest-path apps/farmctl/Cargo.toml -- \
  bundle \
  --version 0.1.9.248-derived-of-derived \
  --output /Users/Shared/FarmDashboardBuilds/FarmDashboardController-0.1.9.248-derived-of-derived.dmg \
  --native-deps /usr/local/farm-dashboard/native \
  |& tee /Users/Shared/FarmDashboardBuilds/logs/bundle-0.1.9.248-derived-of-derived.log
```

## Refresh (upgrade installed controller)

Set bundle path:

```bash
curl -fsS -X POST http://127.0.0.1:8800/api/config \
  -H 'Content-Type: application/json' \
  -d '{"bundle_path":"/Users/Shared/FarmDashboardBuilds/FarmDashboardController-0.1.9.248-derived-of-derived.dmg"}'
```

Upgrade:

```bash
curl -fsS -X POST http://127.0.0.1:8800/api/upgrade
```

Post-upgrade installed version: `0.1.9.248-derived-of-derived` (from `http://127.0.0.1:8800/api/status`)

## Validation

- Installed smoke: `make e2e-installed-health-smoke` → **PASS**

### DW-218: Temp Compensation on derived sensor

- Selected **derived** sensor as the target:
  - Target (derived): `adab2ed19bb1b9dfe189fa81` (“Reservoir Depth (temp compensated)”) on **Pi5 Node 1**
  - Temperature reference: `48cb1ea6e594d19d5060b5f2` (“Weather temperature”)
- Created derived-of-derived compensated sensor:
  - New sensor id: `86c805faf8f1b6d52f3a2fcb`
  - Name: “Reservoir Depth (temp compensated) (temp comp v2)”

API proof:

```bash
TOKEN="$(cat /Users/Shared/FarmDashboardBuilds/playwright_screenshots_token.txt)"
END=$(date -u "+%Y-%m-%dT%H:%M:%SZ")
START=$(date -u -v-7d "+%Y-%m-%dT%H:%M:%SZ")

curl -fsS \
  -H "Authorization: Bearer $TOKEN" \
  "http://127.0.0.1:8000/api/metrics/query?sensor_ids=86c805faf8f1b6d52f3a2fcb&start=${START}&end=${END}&interval=1800&format=json" \
  | jq '.series[0] | {sensor_id, points: (.points | length)}'
```

### DW-219: Derived Sensor Builder uses derived input

- Created a derived sensor on **Pi5 Node 1** using an existing derived sensor as its input:
  - Input (derived): `af370b03a396ea19681af459` (“Node1 DC loads power”)
  - New sensor id: `d12291c2fa44261a4a310a4b`
  - Name: “Test derived-of-derived 2026-02-04T0747”

## Evidence

- Screenshot(s) (captured + viewed):
  - `manual_screenshots_web/tier_a_0.1.9.248-derived-of-derived_cs102_dw218_dw219_20260204_074049Z/compensation_derived_target_created.png`
  - `manual_screenshots_web/tier_a_0.1.9.248-derived-of-derived_cs102_dw218_dw219_20260204_074049Z/derived_builder_derived_input_created.png`

## Notes

- Core server now supports derived sensors that depend on other derived sensors (derived-of-derived) with:
  - Cycle detection
  - Max depth cap (10)
  - Metrics query evaluation that expands + topologically orders derived dependencies
  - Latest-value evaluation that can compute derived-of-derived where possible
