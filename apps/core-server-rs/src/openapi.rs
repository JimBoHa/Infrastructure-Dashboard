use axum::routing::get;
use axum::{Json, Router};
use std::sync::OnceLock;
use utoipa::openapi::security::{Http, HttpAuthScheme, SecurityScheme};
use utoipa::{Modify, OpenApi};

use crate::json::JsonValue;
use crate::state::AppState;

static OPENAPI_SPEC: OnceLock<serde_json::Value> = OnceLock::new();

struct SecurityAddon;

impl Modify for SecurityAddon {
    fn modify(&self, openapi: &mut utoipa::openapi::OpenApi) {
        if openapi.components.is_none() {
            openapi.components = Some(Default::default());
        }
        if let Some(components) = openapi.components.as_mut() {
            components.add_security_scheme(
                "HTTPBearer",
                SecurityScheme::Http(Http::new(HttpAuthScheme::Bearer)),
            );
        }
    }
}

#[derive(OpenApi)]
#[openapi(
    info(title = "Infrastructure Dashboard Core Server", version = "0.1.0"),
    modifiers(&SecurityAddon),
    paths(
        crate::routes::health::healthz_handler,
        crate::routes::auth::login,
        crate::routes::auth::me,
        crate::routes::auth::bootstrap,
        crate::routes::api_tokens::list_api_tokens,
        crate::routes::api_tokens::revoke_api_token,
        crate::routes::users::list_users,
        crate::routes::users::create_user,
        crate::routes::users::update_user,
        crate::routes::users::delete_user,
        crate::routes::nodes::list_nodes,
        crate::routes::nodes::create_node,
        crate::routes::nodes::get_node,
        crate::routes::nodes::update_node,
        crate::routes::nodes::delete_node,
        crate::routes::nodes::update_node_order,
        crate::routes::node_sensors::get_node_sensors_config,
        crate::routes::node_sensors::update_node_sensors_config,
        crate::routes::node_sensors::update_node_sensors_order,
        crate::routes::display_profiles::get_node_display_profile,
        crate::routes::display_profiles::update_node_display_profile,
        crate::routes::sensors::list_sensors,
        crate::routes::sensors::get_sensor,
        crate::routes::sensors::create_sensor,
        crate::routes::sensors::update_sensor,
        crate::routes::sensors::delete_sensor,
        crate::routes::outputs::list_outputs,
        crate::routes::outputs::get_output,
        crate::routes::outputs::create_output,
        crate::routes::outputs::update_output,
        crate::routes::outputs::delete_output,
        crate::routes::outputs::command_output,
        crate::routes::schedules::list_schedules,
        crate::routes::schedules::get_schedule,
        crate::routes::schedules::create_schedule,
        crate::routes::schedules::update_schedule,
        crate::routes::schedules::delete_schedule,
        crate::routes::schedules::calendar,
        crate::routes::alarm_rules::list_alarm_rules,
        crate::routes::alarm_rules::get_alarm_rule,
        crate::routes::alarm_rules::create_alarm_rule,
        crate::routes::alarm_rules::update_alarm_rule,
        crate::routes::alarm_rules::delete_alarm_rule,
        crate::routes::alarm_rules::enable_alarm_rule,
        crate::routes::alarm_rules::disable_alarm_rule,
        crate::routes::alarm_rules::preview_alarm_rule,
        crate::routes::alarm_rules::alarm_rule_stats,
        crate::routes::alarms::list_alarms,
        crate::routes::alarms::alarm_history,
        crate::routes::alarms::acknowledge_event,
        crate::routes::alarms::acknowledge_events_bulk,
        crate::routes::incidents::list_incidents,
        crate::routes::incidents::get_incident,
        crate::routes::incidents::assign_incident,
        crate::routes::incidents::snooze_incident,
        crate::routes::incidents::close_incident,
        crate::routes::incidents::list_incident_notes,
        crate::routes::incidents::create_incident_note,
        crate::routes::action_logs::list_action_logs,
        crate::routes::metrics::query_metrics,
        crate::routes::metrics::ingest_metrics,
        crate::routes::annotations::list_annotations,
        crate::routes::annotations::create_annotation,
        crate::routes::annotations::update_annotation,
        crate::routes::annotations::delete_annotation,
        crate::routes::analysis::create_job,
        crate::routes::analysis::get_job,
        crate::routes::analysis::get_job_events,
        crate::routes::analysis::cancel_job,
        crate::routes::analysis::get_job_result,
        crate::routes::analysis::preview,
        crate::routes::map::get_map_settings,
        crate::routes::map::update_map_settings,
        crate::routes::map::list_map_saves,
        crate::routes::map::create_map_save,
        crate::routes::map::apply_map_save,
        crate::routes::map::list_map_layers,
        crate::routes::map::create_map_layer,
        crate::routes::map::update_map_layer,
        crate::routes::map::delete_map_layer,
        crate::routes::map::list_map_features,
        crate::routes::map::create_map_feature,
        crate::routes::map::update_map_feature,
        crate::routes::map::delete_map_feature,
        crate::routes::map_assets::get_offline_tile,
        crate::routes::map_assets::get_glyph_range,
        crate::routes::map_offline::list_offline_packs,
        crate::routes::map_offline::get_offline_pack,
        crate::routes::map_offline::install_offline_pack,
        crate::routes::backups::run_backups,
        crate::routes::backups::list_backups,
        crate::routes::backups::list_backups_for_node,
        crate::routes::backups::download_backup,
        crate::routes::backups::restore_backup,
        crate::routes::backups::get_retention,
        crate::routes::backups::update_retention,
        crate::routes::backups::recent_restores,
        crate::routes::backups_exports::export_app_settings,
        crate::routes::backups_exports::import_app_settings,
        crate::routes::backups_exports::export_database,
        crate::routes::connection::get_connection,
        crate::routes::connection::update_connection,
        crate::routes::controller_config::get_controller_runtime_config,
        crate::routes::controller_config::patch_controller_runtime_config,
        crate::routes::dev_activity::get_dev_activity_status,
        crate::routes::dev_activity::heartbeat_dev_activity,
        crate::routes::dev_activity::clear_dev_activity,
        crate::routes::forecast::latest_forecast,
        crate::routes::forecast::latest_forecast_value,
        crate::routes::forecast::forecast_status,
        crate::routes::forecast::poll_forecast,
        crate::routes::forecast::ingest_forecast,
        crate::routes::forecast::get_weather_config,
        crate::routes::forecast::update_weather_config,
        crate::routes::forecast::weather_current,
        crate::routes::forecast::weather_hourly,
        crate::routes::forecast::weather_daily,
        crate::routes::forecast::check_pv_plane,
        crate::routes::forecast::get_pv_config,
        crate::routes::forecast::update_pv_config,
        crate::routes::forecast::pv_hourly,
        crate::routes::forecast::pv_daily,
        crate::routes::external_devices::get_device_catalog,
        crate::routes::external_devices::list_devices,
        crate::routes::external_devices::create_device,
        crate::routes::external_devices::sync_device,
        crate::routes::external_devices::delete_device,
        crate::routes::analytics::feeds_status,
        crate::routes::analytics::feeds_poll,
        crate::routes::analytics::power,
        crate::routes::analytics::water,
        crate::routes::analytics::soil,
        crate::routes::analytics::status,
        crate::routes::indicators::latest_indicators,
        crate::routes::indicators::indicator_keys,
        crate::routes::indicators::indicator_status,
        crate::routes::indicators::recompute_indicators,
        crate::routes::templates::sensor_templates,
        crate::routes::templates::output_templates,
        crate::routes::setup::list_credentials,
        crate::routes::setup::upsert_credential,
        crate::routes::setup::delete_credential,
        crate::routes::setup::emporia_login,
        crate::routes::setup::emporia_devices,
        crate::routes::setup::emporia_update_devices,
        crate::routes::setup::get_mapillary_token,
        crate::routes::predictive::predictive_trace,
        crate::routes::predictive::predictive_status,
        crate::routes::predictive::update_config,
        crate::routes::predictive::bootstrap,
        crate::routes::discovery::scan_nodes,
        crate::routes::discovery::issue_adoption_token,
        crate::routes::discovery::adopt_node,
        crate::routes::dashboard::dashboard_state,
        crate::routes::deployments::start_pi5_deployment,
        crate::routes::deployments::get_pi5_deployment,
        crate::routes::deployments::scan_pi5_host_key,
        crate::routes::weather_stations::create_ws2902,
        crate::routes::weather_stations::get_ws2902_status,
        crate::routes::weather_stations::get_ws2902_status_for_node,
        crate::routes::weather_stations::update_ws2902,
        crate::routes::weather_stations::rotate_ws2902_token,
        crate::routes::weather_stations::rotate_ws2902_token_for_node,
        crate::routes::weather_stations::ingest_ws_short,
        crate::routes::weather_stations::ingest_ws2902,
        crate::routes::renogy::apply_renogy_bt2_preset,
        crate::routes::renogy_settings::get_register_map_schema,
        crate::routes::renogy_settings::get_desired_settings,
        crate::routes::renogy_settings::put_desired_settings,
        crate::routes::renogy_settings::validate_settings,
        crate::routes::renogy_settings::read_current_settings,
        crate::routes::renogy_settings::apply_settings,
        crate::routes::renogy_settings::list_history,
        crate::routes::renogy_settings::rollback,
        crate::routes::renogy_settings::set_maintenance_mode,
        crate::routes::battery::get_battery_config,
        crate::routes::battery::put_battery_config,
        crate::routes::power_runway::get_power_runway_config,
        crate::routes::power_runway::put_power_runway_config,
    )
    ,
    components(schemas(
        crate::routes::health::HealthResponse,
        crate::routes::alarm_rules::AlarmRuleResponse,
        crate::routes::alarm_rules::CreateAlarmRuleRequest,
        crate::routes::alarm_rules::UpdateAlarmRuleRequest,
        crate::routes::alarm_rules::AlarmRulePreviewRequest,
        crate::routes::alarm_rules::AlarmRulePreviewResponse,
        crate::routes::alarm_rules::AlarmRuleStatsRequest,
        crate::routes::alarm_rules::AlarmRuleStatsResponse,
        crate::routes::alarm_rules::AlarmRuleStatsSensorResponse,
        crate::routes::alarm_rules::AlarmRuleStatsBands,
        crate::routes::alarm_rules::AlarmRuleStatsBandSet,
        crate::routes::alarm_rules::AlarmRuleDeleteResponse,
        crate::services::alarm_engine::PreviewTargetResult,
        crate::routes::alarms::AlarmResponse,
        crate::routes::alarms::AlarmEventResponse,
        crate::routes::alarms::BulkAcknowledgeRequest,
        crate::routes::alarms::BulkAcknowledgeResponse,
        crate::routes::incidents::IncidentResponse,
        crate::routes::incidents::IncidentsListResponse,
        crate::routes::incidents::IncidentDetailResponse,
        crate::routes::incidents::IncidentAssignRequest,
        crate::routes::incidents::IncidentSnoozeRequest,
        crate::routes::incidents::IncidentCloseRequest,
        crate::routes::incidents::IncidentNoteResponse,
        crate::routes::incidents::IncidentNotesListResponse,
        crate::routes::incidents::IncidentNoteCreateRequest,
        crate::routes::action_logs::ActionLogResponse,
        crate::routes::analytics::AnalyticsIntegration,
        crate::routes::analytics::AnalyticsTimeSeriesPoint,
        crate::routes::analytics::AnalyticsRateSchedule,
        crate::routes::analytics::AnalyticsPower,
        crate::routes::analytics::AnalyticsSoilField,
        crate::routes::analytics::AnalyticsSoil,
        crate::routes::analytics::AnalyticsFeedStatusEntry,
        crate::routes::analytics::AnalyticsFeedHistoryEntry,
        crate::routes::analytics::AnalyticsFeedStatusResponse,
        crate::routes::analytics::AnalyticsPollResponse,
        crate::routes::analytics::AnalyticsWater,
        crate::routes::analytics::AnalyticsStatus,
        crate::routes::api_tokens::ApiTokenInfo,
        crate::routes::auth::LoginRequest,
        crate::routes::auth::LoginResponse,
        crate::routes::auth::AuthMeResponse,
        crate::routes::auth::AuthBootstrapResponse,
        crate::routes::annotations::AnnotationResponse,
        crate::routes::annotations::CreateAnnotationRequest,
        crate::routes::annotations::UpdateAnnotationRequest,
        crate::routes::backups::BackupFileInfo,
        crate::routes::backups::BackupNodeMetadata,
        crate::routes::backups::BackupSummary,
        crate::routes::backups::RestoreRequest,
        crate::routes::backups::BackupRunResponse,
        crate::routes::backups::RetentionPolicyUpdate,
        crate::routes::backups::RetentionUpdateRequest,
        crate::routes::backups::RetentionPolicyResponse,
        crate::routes::backups::RetentionConfigResponse,
        crate::routes::backups::RestoreResponse,
        crate::routes::backups_exports::SetupConfigSnapshot,
        crate::routes::backups_exports::SetupCredentialSnapshot,
        crate::routes::backups_exports::BackupRetentionSnapshot,
        crate::routes::backups_exports::BackupRetentionPolicySnapshot,
        crate::routes::backups_exports::MapLayerSnapshot,
        crate::routes::backups_exports::MapFeatureSnapshot,
        crate::routes::backups_exports::MapSaveSnapshot,
        crate::routes::backups_exports::MapSettingsSnapshot,
        crate::routes::backups_exports::MapSnapshot,
        crate::routes::backups_exports::AppSettingsBundle,
        crate::routes::backups_exports::AppSettingsImportApplied,
        crate::routes::backups_exports::AppSettingsImportResponse,
        crate::routes::connection::ConnectionResponse,
        crate::routes::connection::ConnectionUpdate,
        crate::routes::controller_config::ControllerRuntimeConfigResponse,
        crate::routes::controller_config::ControllerRuntimeConfigPatchRequest,
        crate::routes::dev_activity::DevActivityStatusResponse,
        crate::routes::dev_activity::DevActivityHeartbeatRequest,
        crate::routes::dashboard::DashboardBackupEntry,
        crate::routes::dashboard::DashboardSnapshot,
        crate::routes::discovery::AdoptionCandidate,
        crate::routes::discovery::AdoptionTokenRequest,
        crate::routes::discovery::AdoptionTokenResponse,
        crate::routes::discovery::AdoptRequest,
        crate::routes::forecast::ForecastDatumRead,
        crate::routes::forecast::ForecastIngestItem,
        crate::routes::forecast::ForecastIngestRequest,
        crate::routes::forecast::ForecastIngestResponse,
        crate::routes::forecast::ForecastSeriesPoint,
        crate::routes::forecast::ForecastSeriesMetric,
        crate::routes::forecast::ForecastSeriesResponse,
        crate::routes::forecast::WeatherForecastConfigResponse,
        crate::routes::forecast::WeatherForecastConfigRequest,
        crate::routes::forecast::CurrentWeatherMetric,
        crate::routes::forecast::CurrentWeatherResponse,
        crate::routes::forecast::PvForecastConfigResponse,
        crate::routes::forecast::PvForecastConfigRequest,
        crate::routes::forecast::PvForecastCheckRequest,
        crate::routes::forecast::PvForecastCheckResponse,
        crate::routes::external_devices::ExternalDeviceCatalogResponse,
        crate::routes::external_devices::ExternalDeviceSummary,
        crate::routes::external_devices::ExternalDeviceCreateRequest,
        crate::device_catalog::DeviceCatalog,
        crate::device_catalog::DeviceVendor,
        crate::device_catalog::DeviceModel,
        crate::device_catalog::DevicePoint,
        crate::routes::indicators::AnalyticsIndicatorRead,
        crate::routes::metrics::MetricPoint,
        crate::routes::metrics::MetricSeries,
        crate::routes::metrics::MetricsResponse,
        crate::routes::metrics::MetricIngestItem,
        crate::routes::metrics::MetricIngestRequest,
        crate::routes::metrics::MetricIngestResponse,
        crate::services::analysis::jobs::AnalysisJobStatus,
        crate::services::analysis::jobs::AnalysisJobProgress,
        crate::services::analysis::jobs::AnalysisJobError,
        crate::services::analysis::jobs::AnalysisJobPublic,
        crate::services::analysis::jobs::AnalysisJobEventPublic,
        crate::services::analysis::jobs::AnalysisJobEventsResponse,
        crate::services::analysis::jobs::AnalysisJobCreateRequest,
        crate::services::analysis::jobs::AnalysisJobCreateResponse,
        crate::services::analysis::jobs::AnalysisJobStatusResponse,
        crate::services::analysis::jobs::AnalysisJobCancelResponse,
        crate::services::analysis::jobs::AnalysisJobResultResponse,
        crate::services::analysis::tsse::types::TssePreviewRequestV1,
        crate::services::analysis::tsse::types::TssePreviewResponseV1,
        crate::services::analysis::tsse::types::TssePreviewSeriesV1,
        crate::services::analysis::tsse::types::TssePreviewSeriesPointV1,
        crate::services::analysis::tsse::types::TsseEpisodeV1,
        crate::routes::node_sensors::NodeSensorDraft,
        crate::routes::node_sensors::NodeAds1263SettingsDraft,
        crate::routes::node_sensors::NodeAnalogHealth,
        crate::routes::node_sensors::NodeSensorsConfigResponse,
        crate::routes::node_sensors::NodeSensorsConfigUpdateRequest,
        crate::routes::node_sensors::NodeSensorsOrderUpdateRequest,
        crate::routes::node_sensors::ApplyNodeSensorsConfigResponse,
        crate::routes::map::MapSettingsResponse,
        crate::routes::map::MapSettingsUpdateRequest,
        crate::routes::map::MapSaveResponse,
        crate::routes::map::MapSaveCreateRequest,
        crate::routes::map::MapLayerResponse,
        crate::routes::map::MapLayerUpsertRequest,
        crate::routes::map::MapFeatureResponse,
        crate::routes::map::MapFeatureUpsertRequest,
        crate::routes::map_offline::OfflineMapPackResponse,
        crate::routes::nodes::NodeResponse,
        crate::routes::nodes::NodeCreateRequest,
        crate::routes::nodes::NodeUpdateRequest,
        crate::routes::nodes::NodeOrderUpdateRequest,
        crate::routes::display_profiles::DisplayTileType,
        crate::routes::display_profiles::DisplayTile,
        crate::routes::display_profiles::DisplayTrendRange,
        crate::routes::display_profiles::DisplayTrendConfig,
        crate::routes::display_profiles::NodeDisplayProfile,
        crate::routes::display_profiles::UpdateNodeDisplayProfileResponse,
        crate::routes::outputs::OutputResponse,
        crate::routes::outputs::OutputCreateRequest,
        crate::routes::outputs::OutputUpdateRequest,
        crate::routes::outputs::OutputCommandRequest,
        crate::routes::predictive::PredictiveStatus,
        crate::routes::predictive::PredictiveTraceEntry,
        crate::routes::predictive::PredictiveBootstrapResponse,
        crate::routes::predictive::PredictiveConfigUpdate,
        crate::routes::renogy::RenogyBt2Mode,
        crate::routes::renogy::ApplyRenogyBt2PresetRequest,
        crate::routes::renogy::RenogyPresetSensor,
        crate::routes::renogy::ApplyRenogyBt2PresetResponse,
        crate::routes::renogy_settings::RenogyMaintenanceModeRequest,
        crate::routes::renogy_settings::RenogyRegisterMapSchema,
        crate::routes::renogy_settings::RenogyDesiredSettingsResponse,
        crate::routes::renogy_settings::RenogyDesiredSettingsUpdateRequest,
        crate::routes::renogy_settings::RenogyValidateResponse,
        crate::routes::renogy_settings::RenogyReadCurrentResponse,
        crate::routes::renogy_settings::RenogyApplyResponse,
        crate::routes::renogy_settings::RenogyHistoryEntry,
        crate::routes::renogy_settings::RenogyRollbackRequest,
        crate::routes::battery::BatteryConfigResponse,
        crate::routes::battery::BatteryConfigRequest,
        crate::services::battery_model::BatteryModelConfig,
        crate::services::battery_model::BatteryChemistry,
        crate::services::battery_model::CurrentSignMode,
        crate::services::battery_model::SocAnchorMode,
        crate::services::battery_model::CapacityEstimationConfig,
        crate::routes::power_runway::PowerRunwayConfigResponse,
        crate::routes::power_runway::PowerRunwayConfigRequest,
        crate::services::power_runway::PowerRunwayConfig,
        crate::routes::schedules::ScheduleResponse,
        crate::routes::schedules::ScheduleUpsertRequest,
        crate::routes::schedules::ScheduleCalendarEvent,
        crate::routes::sensors::SensorResponse,
        crate::routes::sensors::SensorCreateRequest,
        crate::routes::sensors::SensorUpdateRequest,
        crate::services::sensor_visibility::SensorVisibilityInfo,
        crate::routes::setup::SetupCredential,
        crate::routes::setup::SetupCredentialsResponse,
        crate::routes::setup::UpsertCredentialRequest,
        crate::routes::setup::EmporiaLoginRequest,
        crate::routes::setup::EmporiaLoginResponse,
        crate::routes::setup::EmporiaCircuitSettings,
        crate::routes::setup::EmporiaDeviceSettings,
        crate::routes::setup::EmporiaDevicesResponse,
        crate::routes::setup::EmporiaCircuitUpdate,
        crate::routes::setup::EmporiaDeviceUpdate,
        crate::routes::setup::EmporiaDevicesUpdateRequest,
        crate::services::emporia::EmporiaDeviceInfo,
        crate::routes::setup::MapillaryTokenResponse,
        crate::routes::templates::TemplatesResponse,
        crate::routes::users::UserCreateRequest,
        crate::routes::users::UserUpdateRequest,
        crate::routes::users::UserResponse,
        crate::routes::weather_stations::Ws2902Protocol,
        crate::routes::weather_stations::Ws2902CreateRequest,
        crate::routes::weather_stations::Ws2902CreatedSensor,
        crate::routes::weather_stations::Ws2902CreateResponse,
        crate::routes::weather_stations::Ws2902UpdateRequest,
        crate::routes::weather_stations::Ws2902StatusResponse,
        crate::routes::weather_stations::Ws2902RotateTokenResponse,
        JsonValue,
        crate::services::deployments::StepStatus,
        crate::services::deployments::JobStatus,
        crate::services::deployments::DeploymentStep,
        crate::services::deployments::DeploymentNodeInfo,
        crate::services::deployments::DeploymentJob,
        crate::services::deployments::PiDeploymentRequest,
        crate::services::deployments::HostKeyScanRequest,
        crate::services::deployments::HostKeyScanResponse,
    ))
)]
pub struct ApiDoc;

pub fn openapi_json() -> serde_json::Value {
    OPENAPI_SPEC
        .get_or_init(|| {
            serde_json::to_value(ApiDoc::openapi()).unwrap_or_else(|_| serde_json::json!({}))
        })
        .clone()
}

async fn openapi_handler() -> Json<serde_json::Value> {
    Json(openapi_json())
}

pub fn router() -> Router<AppState> {
    Router::new().route("/openapi.json", get(openapi_handler))
}
