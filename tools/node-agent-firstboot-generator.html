<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Node Agent First-Boot Config Generator</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #0f172a;
        --panel: #ffffff;
        --muted: #64748b;
        --text: #0f172a;
        --border: #e2e8f0;
        --danger: #dc2626;
        --danger-bg: #fef2f2;
        --danger-border: #fecaca;
        --ok: #16a34a;
        --ok-bg: #f0fdf4;
        --ok-border: #bbf7d0;
        --primary: #0f172a;
        --primary-hover: #1e293b;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: linear-gradient(140deg, var(--bg), #1e293b);
        color: var(--text);
      }

      .container {
        max-width: 1024px;
        margin: 0 auto;
        padding: 32px 16px 48px;
      }

      header {
        color: #e2e8f0;
        margin-bottom: 20px;
      }

      header h1 {
        margin: 0 0 6px;
        font-size: 22px;
        letter-spacing: -0.02em;
      }

      header p {
        margin: 0;
        color: #cbd5e1;
        font-size: 13px;
        line-height: 1.45;
        max-width: 80ch;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }

      @media (min-width: 900px) {
        .grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.18);
      }

      .card h2 {
        margin: 0 0 6px;
        font-size: 14px;
      }

      .card p.help {
        margin: 0 0 12px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }

      label {
        display: grid;
        gap: 6px;
        font-size: 12px;
        color: var(--text);
      }

      label span {
        font-weight: 650;
      }

      input,
      textarea {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 13px;
        outline: none;
      }

      textarea {
        resize: vertical;
        min-height: 130px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      input.invalid {
        border-color: var(--danger-border);
        background: var(--danger-bg);
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }

      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        padding: 9px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 650;
        cursor: pointer;
      }

      .btn.primary {
        border-color: transparent;
        background: var(--primary);
        color: #ffffff;
      }

      .btn.primary:hover {
        background: var(--primary-hover);
      }

      .btn:disabled {
        cursor: not-allowed;
        opacity: 0.55;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 11px;
        font-weight: 650;
        border: 1px solid var(--border);
        color: var(--muted);
        background: #f8fafc;
      }

      .badge.ok {
        border-color: var(--ok-border);
        background: var(--ok-bg);
        color: var(--ok);
      }

      .badge.error {
        border-color: var(--danger-border);
        background: var(--danger-bg);
        color: var(--danger);
      }

      ul.errors {
        margin: 10px 0 0;
        padding-left: 18px;
        color: var(--danger);
        font-size: 12px;
        line-height: 1.45;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }

      .instructions code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        background: #f1f5f9;
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid var(--border);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Node Agent First-Boot Config Generator</h1>
        <p>
          Generates a <code>node-agent-firstboot.json</code> file for offline provisioning (when BLE is unavailable) or
          bulk imaging. The node agent consumes this file once on startup and deletes it after applying changes.
        </p>
      </header>

      <div class="grid">
        <section class="card">
          <h2>Configuration</h2>
          <p class="help">
            Leave fields blank to omit them from the file. At least one field must be set to generate a config.
          </p>

          <div class="form-grid">
            <label>
              <span>Node name</span>
              <input id="nodeName" type="text" placeholder="Field Node 001" autocomplete="off" />
              <div class="muted">Used by dashboards as the friendly display name.</div>
            </label>

            <label>
              <span>Node ID (optional)</span>
              <input id="nodeId" type="text" placeholder="pi-node-001" autocomplete="off" />
              <div class="muted">MQTT/zeroconf identifier. Allowed: letters, numbers, <code>-</code>, <code>_</code>.</div>
            </label>

            <div class="row">
              <label style="flex: 1">
                <span>Adoption token (optional)</span>
                <input id="adoptionToken" type="text" placeholder="32 hex chars (optional)" autocomplete="off" />
                <div class="muted">If provided, must be 8–64 hex characters.</div>
              </label>
              <button id="genToken" class="btn" type="button">Generate</button>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 4px 0" />

            <label>
              <span>Wi‑Fi SSID (optional)</span>
              <input id="wifiSsid" type="text" placeholder="FarmWiFi" autocomplete="off" />
              <div class="muted">Must be 1–32 characters if provided.</div>
            </label>

            <label>
              <span>Wi‑Fi password (optional)</span>
              <input id="wifiPassword" type="password" placeholder="(leave blank for open networks)" autocomplete="off" />
              <div class="muted">If provided, must be 8–63 characters (or 64 hex chars).</div>
            </label>

            <div class="row">
              <span id="statusBadge" class="badge">Waiting for input…</span>
              <button id="downloadBtn" class="btn primary" type="button" disabled>Download node-agent-firstboot.json</button>
              <button id="copyBtn" class="btn" type="button" disabled>Copy JSON</button>
              <button id="resetBtn" class="btn" type="button">Reset</button>
            </div>

            <ul id="errors" class="errors" style="display: none"></ul>
          </div>
        </section>

        <section class="card">
          <h2>JSON Preview</h2>
          <p class="help">This is the exact file content that will be downloaded.</p>
          <textarea id="jsonPreview" readonly></textarea>

          <div class="instructions" style="margin-top: 12px">
            <h2 style="margin: 0 0 6px; font-size: 14px">Where to place the file</h2>
            <p class="muted" style="margin: 0 0 8px">
              Copy the downloaded <code>node-agent-firstboot.json</code> next to the node agent config file on the
              target device.
            </p>
            <p class="muted" style="margin: 0 0 8px">
              Default location on the node-agent image:
              <code>/opt/node-agent/storage/node-agent-firstboot.json</code>
            </p>
            <p class="muted" style="margin: 0">
              After the node boots (or after a restart), confirm it applied via the local UI (<code>http://&lt;node&gt;:9000/</code>)
              or <code>/v1/config</code>. The file is removed automatically after processing.
            </p>
          </div>
        </section>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const fields = {
        nodeName: $("nodeName"),
        nodeId: $("nodeId"),
        adoptionToken: $("adoptionToken"),
        wifiSsid: $("wifiSsid"),
        wifiPassword: $("wifiPassword"),
      };

      const statusBadge = $("statusBadge");
      const downloadBtn = $("downloadBtn");
      const copyBtn = $("copyBtn");
      const resetBtn = $("resetBtn");
      const errorsEl = $("errors");
      const jsonPreview = $("jsonPreview");
      const genToken = $("genToken");

      const isHex = (value) => /^[0-9a-fA-F]+$/.test(value);
      const randomHex = (bytes) => {
        const buf = new Uint8Array(bytes);
        crypto.getRandomValues(buf);
        return Array.from(buf)
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      };

      const buildConfig = () => {
        const nodeName = fields.nodeName.value.trim();
        const nodeId = fields.nodeId.value.trim();
        const adoptionToken = fields.adoptionToken.value.trim();
        const wifiSsid = fields.wifiSsid.value;
        const wifiPassword = fields.wifiPassword.value;

        const payload = {};
        const node = {};
        if (nodeName) node.node_name = nodeName;
        if (nodeId) node.node_id = nodeId;
        if (adoptionToken) node.adoption_token = adoptionToken;
        if (Object.keys(node).length) payload.node = node;

        const wifi = {};
        if (wifiSsid.trim()) wifi.ssid = wifiSsid;
        if (wifiPassword) wifi.password = wifiPassword;
        if (Object.keys(wifi).length) payload.wifi = wifi;

        return payload;
      };

      const validate = (payload) => {
        const errors = [];
        const invalid = new Set();

        const nodeName = payload.node?.node_name ?? "";
        const nodeId = payload.node?.node_id ?? "";
        const adoptionToken = payload.node?.adoption_token ?? "";
        const wifiSsid = payload.wifi?.ssid ?? "";
        const wifiPassword = payload.wifi?.password ?? "";

        const hasAnyValue = Boolean(nodeName || nodeId || adoptionToken || wifiSsid || wifiPassword);
        if (!hasAnyValue) {
          errors.push("Set at least one value (node name, node ID, adoption token, or Wi‑Fi SSID).");
        }

        if (nodeName && nodeName.length > 64) {
          errors.push("Node name must be 64 characters or fewer.");
          invalid.add("nodeName");
        }

        if (nodeId) {
          if (nodeId.length > 64) {
            errors.push("Node ID must be 64 characters or fewer.");
            invalid.add("nodeId");
          } else if (!/^[A-Za-z0-9][A-Za-z0-9_-]*$/.test(nodeId)) {
            errors.push("Node ID may contain only letters, numbers, '-' and '_', and must not start with a symbol.");
            invalid.add("nodeId");
          }
        }

        if (adoptionToken) {
          if (adoptionToken.length < 8 || adoptionToken.length > 64 || !isHex(adoptionToken)) {
            errors.push("Adoption token must be 8–64 hex characters.");
            invalid.add("adoptionToken");
          }
        }

        if (wifiPassword && !wifiSsid.trim()) {
          errors.push("Wi‑Fi password was provided but SSID is empty.");
          invalid.add("wifiSsid");
          invalid.add("wifiPassword");
        }

        if (wifiSsid.trim()) {
          const ssidLen = wifiSsid.length;
          if (ssidLen < 1 || ssidLen > 32) {
            errors.push("Wi‑Fi SSID must be 1–32 characters.");
            invalid.add("wifiSsid");
          }

          if (wifiPassword) {
            const passLen = wifiPassword.length;
            const passIsHex64 = passLen === 64 && isHex(wifiPassword);
            const passIsAscii = passLen >= 8 && passLen <= 63;
            if (!passIsAscii && !passIsHex64) {
              errors.push("Wi‑Fi password must be 8–63 characters (or 64 hex characters).");
              invalid.add("wifiPassword");
            }
          }
        }

        return { errors, invalid };
      };

      const setErrors = (errors) => {
        if (!errors.length) {
          errorsEl.style.display = "none";
          errorsEl.innerHTML = "";
          return;
        }
        errorsEl.style.display = "block";
        errorsEl.innerHTML = errors.map((e) => `<li>${e}</li>`).join("");
      };

      const setValidity = ({ ok, message }) => {
        statusBadge.classList.remove("ok", "error");
        statusBadge.classList.add(ok ? "ok" : "error");
        statusBadge.textContent = message;
      };

      const setFieldValidity = (invalid) => {
        for (const [key, el] of Object.entries(fields)) {
          el.classList.toggle("invalid", invalid.has(key));
        }
      };

      const refresh = () => {
        const payload = buildConfig();
        const jsonText = JSON.stringify(payload, null, 2);
        jsonPreview.value = jsonText;

        const { errors, invalid } = validate(payload);
        setErrors(errors);
        setFieldValidity(invalid);

        const ok = errors.length === 0;
        downloadBtn.disabled = !ok;
        copyBtn.disabled = !ok;
        setValidity({ ok, message: ok ? "Valid config ready to download." : "Fix validation errors." });
      };

      const download = () => {
        const payload = buildConfig();
        const text = JSON.stringify(payload, null, 2) + "\n";
        const blob = new Blob([text], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "node-agent-firstboot.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      const copyJson = async () => {
        try {
          await navigator.clipboard.writeText(jsonPreview.value);
          setValidity({ ok: true, message: "Copied JSON to clipboard." });
          setTimeout(refresh, 1200);
        } catch (err) {
          console.warn("clipboard write failed", err);
          setValidity({ ok: false, message: "Copy failed (clipboard unavailable). Use manual copy from preview." });
        }
      };

      const reset = () => {
        fields.nodeName.value = "";
        fields.nodeId.value = "";
        fields.adoptionToken.value = "";
        fields.wifiSsid.value = "";
        fields.wifiPassword.value = "";
        refresh();
      };

      genToken.addEventListener("click", () => {
        fields.adoptionToken.value = randomHex(16);
        refresh();
      });

      downloadBtn.addEventListener("click", download);
      copyBtn.addEventListener("click", copyJson);
      resetBtn.addEventListener("click", reset);

      Object.values(fields).forEach((el) => el.addEventListener("input", refresh));
      refresh();
    </script>
  </body>
</html>

